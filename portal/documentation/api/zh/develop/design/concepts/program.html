<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="design-doc-paddlepaddle-programs">
<span id="design-doc-paddlepaddle-programs"></span><h1>Design Doc: PaddlePaddle Programs<a class="headerlink" href="#design-doc-paddlepaddle-programs" title="永久链接至标题">¶</a></h1>
<div class="section" id="compile-and-execution">
<span id="compile-and-execution"></span><h2>Compile and Execution<a class="headerlink" href="#compile-and-execution" title="永久链接至标题">¶</a></h2>
<p>A PaddlePaddle program consists of two parts – the first generates a <code class="docutils literal"><span class="pre">ProgramDesc</span></code> protobuf message that describes the program, and the second runs this message using a C++ class <code class="docutils literal"><span class="pre">Executor</span></code>.</p>
<p>A simple example PaddlePaddle program can be found in <a class="reference internal" href="../others/graph.html"><span class="doc">graph.md</span></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s2">"images"</span><span class="p">)</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s2">"label"</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">cost</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
<span class="n">optimize</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
<span class="n">train</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="n">mnist</span><span class="o">.</span><span class="n">train</span><span class="p">())</span>
</pre></div>
</div>
<p>The first five lines of the following PaddlePaddle program generates, or, compiles, the <code class="docutils literal"><span class="pre">ProgramDesc</span></code> message.  The last line runs it.</p>
</div>
<div class="section" id="programs-and-blocks">
<span id="programs-and-blocks"></span><h2>Programs and Blocks<a class="headerlink" href="#programs-and-blocks" title="永久链接至标题">¶</a></h2>
<p>The basic structure of a PaddlePaddle program is some nested blocks, as a C++ or Java program.</p>
<ul class="simple">
<li>program: some nested blocks</li>
<li><a class="reference internal" href="block.html"><span class="doc">block</span></a>:<ul>
<li>some local variable definitions, and</li>
<li>a sequence of operators</li>
</ul>
</li>
</ul>
<p>The concept of block comes from usual programs.  For example, the following C++ program has three blocks:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// block 0</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// block 1</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// block 2</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following PaddlePaddle program has three blocks:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">paddle</span> <span class="kn">as</span> <span class="nn">pd</span>  <span class="o">//</span> <span class="n">block</span> <span class="mi">0</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">minibatch</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">])</span> <span class="c1"># shape=[None, 1]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># shape=[1], value=1</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">minibatch</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">])</span> <span class="c1"># shape=[None, 1]</span>
<span class="n">cond</span> <span class="o">=</span> <span class="n">larger_than</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="c1"># [false, true, true]</span>

<span class="n">ie</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ifelse</span><span class="p">()</span>
<span class="k">with</span> <span class="n">ie</span><span class="o">.</span><span class="n">true_block</span><span class="p">():</span>  <span class="o">//</span> <span class="n">block</span> <span class="mi">1</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">ie</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
<span class="k">with</span> <span class="n">ie</span><span class="o">.</span><span class="n">false_block</span><span class="p">():</span>  <span class="o">//</span> <span class="n">block</span> <span class="mi">2</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">ie</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">o1</span><span class="p">,</span> <span class="n">o2</span> <span class="o">=</span> <span class="n">ie</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="blockdesc-and-programdesc">
<span id="blockdesc-and-programdesc"></span><h2><code class="docutils literal"><span class="pre">BlockDesc</span></code> and <code class="docutils literal"><span class="pre">ProgramDesc</span></code><a class="headerlink" href="#blockdesc-and-programdesc" title="永久链接至标题">¶</a></h2>
<p>All protobuf messages are defined in <code class="docutils literal"><span class="pre">framework.proto</span></code>.</p>
<p><code class="docutils literal"><span class="pre">BlockDesc</span></code> is straight-forward – it includes local variable definitions, <code class="docutils literal"><span class="pre">vars</span></code>, and a sequence of operators, <code class="docutils literal"><span class="pre">ops</span></code>.</p>
<div class="highlight-protobuf"><div class="highlight"><pre><span></span><span class="kd">message</span> <span class="nc">BlockDesc</span> <span class="p">{</span>
  <span class="k">required</span> <span class="kt">int32</span> <span class="na">parent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="n">VarDesc</span> <span class="na">vars</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="n">OpDesc</span> <span class="na">ops</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The parent ID indicates the parent block so that operators in a block can refer to variables defined locally and also those defined in their ancestor blocks.</p>
<p>All hierarchical blocks in a program are flattened and stored in an array. The block ID is the index of the block in this array.</p>
<div class="highlight-protobuf"><div class="highlight"><pre><span></span><span class="kd">message</span> <span class="nc">ProgramDesc</span> <span class="p">{</span>
  <span class="k">repeated</span> <span class="n">BlockDesc</span> <span class="na">blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="global-block">
<span id="global-block"></span><h3>Global Block<a class="headerlink" href="#global-block" title="永久链接至标题">¶</a></h3>
<p>The global block is the first one in the above array.</p>
</div>
</div>
<div class="section" id="operators-that-use-blocks">
<span id="operators-that-use-blocks"></span><h2>Operators that Use Blocks<a class="headerlink" href="#operators-that-use-blocks" title="永久链接至标题">¶</a></h2>
<p>In the above example, the operator <code class="docutils literal"><span class="pre">IfElseOp</span></code> has two blocks – the true branch and the false branch.</p>
<p>The definition of <code class="docutils literal"><span class="pre">OpDesc</span></code> shows that an operator could have some attributes:</p>
<div class="highlight-protobuf"><div class="highlight"><pre><span></span><span class="kd">message</span> <span class="nc">OpDesc</span> <span class="p">{</span>
  <span class="n">AttrDesc</span> <span class="na">attrs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and an attribute could be of type block, which is, in fact, a block ID as described above:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">message</span> <span class="n">AttrDesc</span> <span class="p">{</span>
  <span class="n">required</span> <span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="n">enum</span> <span class="n">AttrType</span> <span class="p">{</span>
    <span class="n">INT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">STRING</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="o">...</span>
    <span class="n">BLOCK</span> <span class="o">=</span> <span class="o">...</span>
  <span class="p">}</span>
  <span class="n">required</span> <span class="n">AttrType</span> <span class="nb">type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

  <span class="n">optional</span> <span class="n">int32</span> <span class="n">block</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="o">//</span> <span class="n">when</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">BLOCK</span>
  <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="infershape">
<span id="infershape"></span><h2>InferShape<a class="headerlink" href="#infershape" title="永久链接至标题">¶</a></h2>
<p>With this design, the InferShape function should take the following parameters:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">InferShape</span><span class="p">(</span><span class="kt">int</span> <span class="n">current_block</span><span class="p">,</span>
                <span class="kt">int</span> <span class="n">current_operator</span><span class="p">,</span>
                <span class="n">ProgramDesc</span><span class="o">*</span> <span class="n">program</span> <span class="c1">// might change VarDesc values.</span>
                <span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">current_block</span></code> indices into <code class="docutils literal"><span class="pre">ProgramDesc::blocks</span></code>,</li>
<li><code class="docutils literal"><span class="pre">current_operator</span></code> indices into <code class="docutils literal"><span class="pre">BlockDesc::ops</span></code>.</li>
</ul>
</div>
</div>
</div>
<div class="articleComments">
</div>
</div>