<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="varient-length-supported-rnn-design">
<span id="varient-length-supported-rnn-design"></span><h1>Varient Length supported RNN Design<a class="headerlink" href="#varient-length-supported-rnn-design" title="Permalink to this headline">¶</a></h1>
<p>For the learning of variable length sequences, the existing mainstream frameworks such as tensorflow, pytorch, caffe2, mxnet and so on all use padding.</p>
<p>Different-length sequences in a mini-batch will be padded with zeros and transformed to same length.</p>
<p>The existing RNN implementations of the PaddlePaddle is <code class="docutils literal"><span class="pre">RecurrentLayerGroup</span></code>,
which supports the variable length sequences without padding.
This doc will design fluid’s RNN based on this idea.</p>
<div class="section" id="multi-layer-sequence-data-format-lodtensor">
<span id="multi-layer-sequence-data-format-lodtensor"></span><h2>Multi-layer sequence data format <code class="docutils literal"><span class="pre">LODTensor</span></code><a class="headerlink" href="#multi-layer-sequence-data-format-lodtensor" title="Permalink to this headline">¶</a></h2>
<p>At present, Paddle stores data in one mini-batch in one-dimensional array.</p>
<p><code class="docutils literal"><span class="pre">Argument.sequenceStartPositions</span></code> is used to store information for each sentence.</p>
<p>In Paddle, <code class="docutils literal"><span class="pre">Argument.subSequenceStartPositions</span></code> is used to store 2 levels of sequence information, while higher dimensional sequences can not be supported.</p>
<p>In order to support the storage of <code class="docutils literal"><span class="pre">N-level</span></code> sequences, we define sequence information as the following data structure.</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;&gt;</span> <span class="n">lod_start_pos_</span><span class="p">;</span>
</pre></div>
</div>
<p>Or more clearly defined here</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">level_t</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">level_t</span><span class="o">&gt;</span> <span class="n">lod_start_pos</span><span class="p">;</span>
</pre></div>
</div>
<p>Each <code class="docutils literal"><span class="pre">level_t</span></code> here stores a level of offset information consistent with paddle’s current practice.</p>
<p>In order to transmit sequence information more transparently, we have introduced a new tensor called <code class="docutils literal"><span class="pre">LODTensor</span></code>[1].
Its tensor-related interfaces all inherit directly from <code class="docutils literal"><span class="pre">Tensor</span></code>, but it also adds serial-related interfaces.
Thus, when working with a <code class="docutils literal"><span class="pre">LODTensor</span></code>, ordinary <code class="docutils literal"><span class="pre">Op</span></code> is used directly as <code class="docutils literal"><span class="pre">Tensor</span></code>.
The <code class="docutils literal"><span class="pre">Op</span></code> of the operation sequence will additionally operate the relevant interface of the <code class="docutils literal"><span class="pre">LODTensor</span></code> variable-length sequence operation.</p>
<p>The definition of <code class="docutils literal"><span class="pre">LODTensor</span></code> is as follows:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LODTensor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Tensor</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="kt">size_t</span> <span class="n">Levels</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">seq_start_positions_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="p">}</span>
  <span class="kt">size_t</span> <span class="n">Elements</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">seq_start_positions_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">size</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">// slice of level[elem_begin: elem_end]</span>
  <span class="c1">// NOTE low performance in slice seq_start_positions_.</span>
  <span class="c1">// TODO should call Tensor's Slice.</span>
  <span class="n">LODTensor</span> <span class="n">LODSlice</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">elem_begin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">elem_end</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// slice with tensor's data shared with this.</span>
  <span class="n">LODTensor</span> <span class="nf">LODSliceShared</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">elem_begin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">elem_end</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// copy other's lod_start_pos_, to share LOD info.</span>
  <span class="c1">// NOTE the LOD info sould not be changed.</span>
  <span class="kt">void</span> <span class="nf">ShareConstLODFrom</span><span class="p">(</span><span class="k">const</span> <span class="n">LODTensor</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">lod_start_pos_</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">lod_start_pos_</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// copy other's lod_start_pos_'s content, free to mutate.</span>
  <span class="kt">void</span> <span class="nf">ShareMutableLODFrom</span><span class="p">(</span><span class="k">const</span> <span class="n">LODTensor</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">lod_start_pos_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span> <span class="o">&lt;</span>
                     <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">lod_start_pos_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
                                                   <span class="n">other</span><span class="p">.</span><span class="n">lod_start_pos_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;&gt;</span> <span class="n">lod_start_pos_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Among them, <code class="docutils literal"><span class="pre">lod_start_pos_</span></code> uses <code class="docutils literal"><span class="pre">shared_ptr</span></code> to reduce the cost of storage and replication.
<code class="docutils literal"><span class="pre">LODTensor</span></code> can be thought as an extension of <code class="docutils literal"><span class="pre">Tensor</span></code>, which is almost completely compatible with the original <code class="docutils literal"><span class="pre">Tensor</span></code>.</p>
</div>
<div class="section" id="how-to-support-the-framework">
<span id="how-to-support-the-framework"></span><h2>How to support the framework<a class="headerlink" href="#how-to-support-the-framework" title="Permalink to this headline">¶</a></h2>
<div class="section" id="replace-tensor-with-lodtensor">
<span id="replace-tensor-with-lodtensor"></span><h3>Replace <code class="docutils literal"><span class="pre">Tensor</span></code> with <code class="docutils literal"><span class="pre">LoDTensor</span></code><a class="headerlink" href="#replace-tensor-with-lodtensor" title="Permalink to this headline">¶</a></h3>
<p>To implement the passing of <code class="docutils literal"><span class="pre">LODTensor</span></code>, most <code class="docutils literal"><span class="pre">Tensor</span></code> in the framework need to be replaced with <code class="docutils literal"><span class="pre">LODTensor</span></code>.
Simple implementation, directly <strong>replace all previous <code class="docutils literal"><span class="pre">Tensor</span></code> with <code class="docutils literal"><span class="pre">LODTensor</span></code></strong> , where you can directly modify the <code class="docutils literal"><span class="pre">Tensor</span></code> interface created in <code class="docutils literal"><span class="pre">pybind.cc</span></code>.</p>
<p>In addition, the user may need to perceive the existence of a sequence (such as the sequence of the visualization needs to parse the output sequence in the model), so some of the serial operation APIs also need to be exposed to the python layer.</p>
</div>
<div class="section" id="transmit-lod-start-pos-along-with-the-op-call-chain">
<span id="transmit-lod-start-pos-along-with-the-op-call-chain"></span><h3>Transmit <code class="docutils literal"><span class="pre">lod_start_pos</span></code> along with the Op call chain<a class="headerlink" href="#transmit-lod-start-pos-along-with-the-op-call-chain" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">lod_start_pos</span></code> is passed along with the Op call chain
The framework needs to support the following features to implement the transmit of <code class="docutils literal"><span class="pre">lod_start_pos</span></code>:</p>
<ol class="simple">
<li>Implement the transfer as <code class="docutils literal"><span class="pre">shared_ptr</span></code><ul>
<li>Do not modify the contents of <code class="docutils literal"><span class="pre">lod_start_pos</span></code> as a consumer</li>
<li>Modify producer of <code class="docutils literal"><span class="pre">lod_start_pos</span></code> as producer</li>
<li>Conventions consumer only needs to copy <code class="docutils literal"><span class="pre">shared_ptr</span></code> passed over</li>
<li>producer needs to create its own independent memory to store its own independent modifications and expose <code class="docutils literal"><span class="pre">shared_ptr</span></code> to subsequent consumer</li>
<li>Since the transfer process is implemented by copying <code class="docutils literal"><span class="pre">shared_ptr</span></code>, the framework only needs to pass <code class="docutils literal"><span class="pre">lod_start_pos</span></code> once.</li>
</ul>
</li>
<li>Op is transparent enough not to sense <code class="docutils literal"><span class="pre">lod_start_pos</span></code></li>
<li>Producer Op that needs to modify <code class="docutils literal"><span class="pre">lod_start_pos</span></code> can update its <code class="docutils literal"><span class="pre">lod_start_pos</span></code> data when <code class="docutils literal"><span class="pre">Run</span></code></li>
</ol>
</div>
</div>
<div class="section" id="sorted-by-length">
<span id="sorted-by-length"></span><h2>sorted by length<a class="headerlink" href="#sorted-by-length" title="Permalink to this headline">¶</a></h2>
<p>After sorting by length, the batch size from the forward time step will naturally decrement, and you can directly plug it into Net to do the batch calculation.</p>
<p>For example, the original input:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">origin</span><span class="p">:</span>
<span class="n">xxxx</span>
<span class="n">xx</span>
<span class="n">xxx</span>

<span class="o">-&gt;</span> <span class="nb">sorted</span><span class="p">:</span>
<span class="n">xxxx</span>
<span class="n">xxx</span>
<span class="n">xx</span>
</pre></div>
</div>
<p>After <code class="docutils literal"><span class="pre">SegmentInputs</span></code>, there will be 4 time steps, the input of each time step is as follows (vertical arrangement)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span>    <span class="mi">1</span>    <span class="mi">2</span>    <span class="mi">3</span>
<span class="n">x</span>    <span class="n">x</span>    <span class="n">x</span>    <span class="n">x</span>
<span class="n">x</span>    <span class="n">x</span>    <span class="n">x</span>
<span class="n">x</span>    <span class="n">x</span>
</pre></div>
</div>
<p>In order to track the changes before and after sorting, use here</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">SortedSeqItem</span> <span class="p">{</span>
   <span class="kt">void</span> <span class="o">*</span><span class="n">start</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
   <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="p">};</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SortedSeqItem</span><span class="o">&gt;</span> <span class="n">sorted_seqs</span><span class="p">;</span>
</pre></div>
</div>
<p>To track the position of the sequence after sorting, and add a new interface</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SortedSeqItem</span><span class="o">&gt;</span> <span class="n">SortBySeqLen</span><span class="p">(</span><span class="k">const</span> <span class="n">LODTensor</span><span class="o">&amp;</span> <span class="n">tensor</span><span class="p">);</span>
</pre></div>
</div>
<p>Due to the sequence of input sequences, the following existing interfaces need to be modified:</p>
<ul class="simple">
<li>InitMemories, memory needs to be rearranged according to <code class="docutils literal"><span class="pre">sorted_seqs</span></code></li>
<li>SetmentInputs</li>
<li>ConcatOutputs</li>
</ul>
<p>In addition, because <code class="docutils literal"><span class="pre">sorted_seqs</span></code> needs to be multiplexed with <code class="docutils literal"><span class="pre">RecurrentGradientOp</span></code>, it will become a new output of <code class="docutils literal"><span class="pre">RecurrentOp</span></code>.
It is passed in as an input to <code class="docutils literal"><span class="pre">RecurrentGradientOp</span></code>.</p>
</div>
<div class="section" id="initmemories">
<span id="initmemories"></span><h2>InitMemories<a class="headerlink" href="#initmemories" title="Permalink to this headline">¶</a></h2>
<p>Due to the sequence change, the order of the elements on the <code class="docutils literal"><span class="pre">boot_memories</span></code> batch also needs to be rearranged accordingly.</p>
</div>
<div class="section" id="segmentinputs">
<span id="segmentinputs"></span><h2>SegmentInputs<a class="headerlink" href="#segmentinputs" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">SegmentInputs</span></code> relies on the information of <code class="docutils literal"><span class="pre">sorted_seqs</span></code> to cut the original sequence from the horizontal to the input of each step in the sorted sequence order.</p>
<p>the transition is as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>origin:
xxxx
xx
xxx

   |
   |
  \ /
   !
0    1    2    3
x    x    x    x
x    x    x
x    x
</pre></div>
</div>
</div>
<div class="section" id="concatoutputs">
<span id="concatoutputs"></span><h2>ConcatOutputs<a class="headerlink" href="#concatoutputs" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">ConcatOutputs</span></code> needs</p>
<ul class="simple">
<li>Restore the output of each time step back to the original input sequence order (to prevent the order of Infer phase from being upset)</li>
<li>Concat each sequence as a regular mini-batch representation</li>
</ul>
</div>
<div class="section" id="references">
<span id="references"></span><h2>references<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference external" href="https://en.wikipedia.org/wiki/Level_of_detail">Level of details</a></li>
</ul>
</div>
</div>
</div>
</div>
<div class="articleComments">
</div>
</div>