<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="design-doc-execute-the-program-with-multi-cpu">
<span id="design-doc-execute-the-program-with-multi-cpu"></span><h1>Design Doc: Execute the Program with Multi CPU<a class="headerlink" href="#design-doc-execute-the-program-with-multi-cpu" title="永久链接至标题">¶</a></h1>
<div class="section" id="abstract">
<span id="abstract"></span><h2>Abstract<a class="headerlink" href="#abstract" title="永久链接至标题">¶</a></h2>
<p>This Design Doc propose an approach to make the user-defined Op graph
running with multi-CPU, we will use an auto transpiler to convert the user-defined
Op graph to a multi-CPU Op graph, and run <code class="docutils literal"><span class="pre">ParallelDo</span></code> Op to run the graph.</p>
</div>
<div class="section" id="transpiler">
<span id="transpiler"></span><h2>Transpiler<a class="headerlink" href="#transpiler" title="永久链接至标题">¶</a></h2>
<p><img src="https://raw.githubusercontent.com/PaddlePaddle/Paddle/develop/doc/fluid/images/single-thread@3x.png" width="300"/></p>
<p>After converted:</p>
<p><img src="https://raw.githubusercontent.com/PaddlePaddle/Paddle/develop/doc/fluid/images/multi-threads@3x.png" width="1000"/></p>
</div>
<div class="section" id="implement">
<span id="implement"></span><h2>Implement<a class="headerlink" href="#implement" title="永久链接至标题">¶</a></h2>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">Multi-CPU</span> <span class="pre">Transpiler</span></code> will convert the graph to a multi-CPU graph
which would be executed with multi-threads.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">BlockingCounter</span></code> will <code class="docutils literal"><span class="pre">Init/Decrement</span></code> an atomic counter, and Blocking <code class="docutils literal"><span class="pre">Wait</span></code>
for the atomic counter become <code class="docutils literal"><span class="pre">0</span></code>:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">BlockingCounter</span> <span class="nf">bc</span><span class="p">(</span><span class="n">thread_count</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">thread_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">thread_pool</span><span class="o">-&gt;</span><span class="n">Start</span><span class="p">([</span><span class="o">&amp;</span><span class="n">bc</span><span class="p">]</span> <span class="p">{</span><span class="n">bc</span><span class="p">.</span><span class="n">DecrementCount</span><span class="p">();</span> <span class="p">})</span>
<span class="p">}</span>
<span class="n">bc</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ParallelDo</span></code> Operator</p>
<ul class="simple">
<li>Initialize a thread pool which is a Singleton.</li>
<li>Use a block id as the input, and create run the specify Block on independent scope
with multi-threads.</li>
<li>Initialize a <code class="docutils literal"><span class="pre">BlockingCounter</span></code> instance and wait until all threads are done.</li>
</ul>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">Split</span></code> Operator will split the Input Tensor into a TensorArray.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">Merge</span></code> merge all the gradients which calculated in different threads
with <code class="docutils literal"><span class="pre">mean/sum/max/min...</span></code> method, and then run the Optimizer Op to optimize <code class="docutils literal"><span class="pre">W</span></code>.</p>
</li>
</ul>
</div>
<div class="section" id="todo">
<span id="todo"></span><h2>TODO<a class="headerlink" href="#todo" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li>Improve the optimizer stage with multi-threads, since we could
assign the parameters to the different threads and execute
optimizer with multi-threads.</li>
</ul>
</div>
</div>
</div>
<div class="articleComments">
</div>
</div>