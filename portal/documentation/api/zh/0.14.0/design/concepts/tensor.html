<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="tensor-an-unified-data-type-in-paddlepaddle">
<span id="tensor-an-unified-data-type-in-paddlepaddle"></span><h1>Tensor: An Unified Data Type in PaddlePaddle<a class="headerlink" href="#tensor-an-unified-data-type-in-paddlepaddle" title="永久链接至标题">¶</a></h1>
<div class="section" id="pain-point">
<span id="pain-point"></span><h2>Pain Point<a class="headerlink" href="#pain-point" title="永久链接至标题">¶</a></h2>
<p>In this week, we discussed several potential weaknesses of PaddlePaddle caused by rapid iteration and development to promote new business products on the line in recent four years. For instance, current Matrix/Vector implementation in PaddlePaddle are long and tedious to read, which interfered seriously with the contribution of both fresh and professional engineers. More seriously for this issue, it will also become too challenging to maintain over time.</p>
</div>
<div class="section" id="learn-from-majel">
<span id="learn-from-majel"></span><h2>Learn from Majel<a class="headerlink" href="#learn-from-majel" title="永久链接至标题">¶</a></h2>
<p>Consequently, we decide to refactor PaddlePaddle step-by-step. First, refactor and replace Matrix/Vector to Tensor, a modern terminology in the deep learning system. Fortunately, we can learn from Majel how to define a Tensor.</p>
<p>To simplify heterogeneous resource allocation in any dimensions (1-9) and types (double, float, float16), Majel consists of several primitives such as <code class="docutils literal"><span class="pre">Dim</span></code>, <code class="docutils literal"><span class="pre">Place</span></code> and <code class="docutils literal"><span class="pre">Array</span></code>, all of them are standard C++ class templates.</p>
<ol class="simple">
<li><code class="docutils literal"><span class="pre">Place</span></code>: memory location [i.e. CPU/GPU].</li>
<li><code class="docutils literal"><span class="pre">Allocation</span></code>: heterogeneous resource allocator [i.e. 20MB in GPU].</li>
<li><code class="docutils literal"><span class="pre">Dim</span></code>: size of each dimension. [i.e. Dim&lt;4&gt;({10, 2, 5, 1})]</li>
<li><code class="docutils literal"><span class="pre">Array</span></code>: dynamic array consists of <code class="docutils literal"><span class="pre">Place</span></code>, <code class="docutils literal"><span class="pre">Dim</span></code>, and a pointer to memory.</li>
</ol>
<p>If you dig deeper into Majel source code, you will find Majel heavily use <code class="docutils literal"><span class="pre">boost.variant</span></code>. The variant class template is a safe, generic, stack-based discriminated union container, <strong>offering a simple solution for manipulating an object from a heterogeneous set of types in a uniform manner</strong>. Whereas standard containers such as std::vector may be thought of as “multi-value, single type,” variant is “multi-type, single value.”</p>
<p>As a simple example, consider the following:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">"boost/variant.hpp"</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">my_visitor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">boost</span><span class="o">::</span><span class="n">static_visitor</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="kt">int</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="kt">int</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&gt;</span> <span class="n">u</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">;</span> <span class="c1">// output: hello world</span>

    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">apply_visitor</span><span class="p">(</span> <span class="n">my_visitor</span><span class="p">(),</span> <span class="n">u</span> <span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// output: 11 (i.e., length of "hello world")</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In Majel, <code class="docutils literal"><span class="pre">DDimVar</span></code> is derived from <code class="docutils literal"><span class="pre">Dim</span></code>, <code class="docutils literal"><span class="pre">DArrayVar</span></code> is from <code class="docutils literal"><span class="pre">Array</span></code>.</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">i</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">Dim</span> <span class="p">{</span>
<span class="p">...</span>    
<span class="kt">int</span> <span class="n">head</span><span class="p">;</span>
<span class="n">Dim</span><span class="o">&lt;</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">tail</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="kt">int</span> <span class="n">D</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">Array</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Buffer</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="k">private</span><span class="o">:</span>
    <span class="n">Dim</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span> <span class="n">size_</span><span class="p">;</span>
    <span class="n">Dim</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span> <span class="n">stride_</span><span class="p">;</span>
    <span class="n">T</span><span class="o">*</span> <span class="n">ptr_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="n">CUDAPlace</span><span class="p">,</span> <span class="n">CpuPlace</span><span class="o">&gt;</span> <span class="n">Place</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="n">Dim</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Dim</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Dim</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Dim</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Dim</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="p">,</span>
                       <span class="n">Dim</span><span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Dim</span><span class="o">&lt;</span><span class="mi">7</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Dim</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Dim</span><span class="o">&lt;</span><span class="mi">9</span><span class="o">&gt;&gt;</span> <span class="n">DDimVar</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span>
    <span class="n">Array</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Array</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Array</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Array</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span><span class="p">,</span>

    <span class="n">Array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span><span class="p">,</span>

    <span class="n">Array</span><span class="o">&lt;</span><span class="n">float16</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Array</span><span class="o">&lt;</span><span class="n">float16</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Array</span><span class="o">&lt;</span><span class="n">float16</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Array</span><span class="o">&lt;</span><span class="n">float16</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">DArrayVar</span><span class="p">;</span>
</pre></div>
</div>
<p>Because <code class="docutils literal"><span class="pre">variant</span></code> may be thought of as “multi-type, single value”, we can utilize it to implement unified interfaces for PaddlePaddle.</p>
<p><code class="docutils literal"><span class="pre">DDim</span></code> plays two kinds of roles in Majel. First, it is used to indicate the size of a tensor. For example, we can construct a new <code class="docutils literal"><span class="pre">DArray</span></code> by following way:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">DArray</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">make_darray</span><span class="p">(</span><span class="n">make_ddim</span><span class="p">({</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}),</span> <span class="mf">0.0f</span><span class="p">);</span>
</pre></div>
</div>
<p>It means that <code class="docutils literal"><span class="pre">arr</span></code> will be a two-dimension tensor, or a matrix. The size of its first dimension is 2 and the second is 3. All the element value of <code class="docutils literal"><span class="pre">arr</span></code> will be initialized as 0.0 .</p>
<p>The second meaning of <code class="docutils literal"><span class="pre">DDim</span></code> is tensor index. For example, if we want to access the value in the 1st row and 2nd column of <code class="docutils literal"><span class="pre">arr</span></code> and set it to 1.0, we can do like this:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>arr[make_ddim({0, 1})] = 1.0；
</pre></div>
</div>
</div>
<div class="section" id="implement-tensor-in-paddle">
<span id="implement-tensor-in-paddle"></span><h2>Implement Tensor in Paddle<a class="headerlink" href="#implement-tensor-in-paddle" title="永久链接至标题">¶</a></h2>
<p>We want to create a Tensor class to replace Vector and Matrix, and to support high-dimensional data. The operations on Tensor are implemented in both CPU and GPU. We also want to make sure that the Tensor interface is friendly to its callers.</p>
<p>Tensor is only responsible for describing computing. It will not take charge of memory allocation policy, handles of some CUDA library context(e.g. cublasHandle, cudnnHandle), and dispatching CUDA kernels. Paddle has realize the initialization and resources management of hardware.</p>
<p>Before writing code, please make sure you already look through Majel Source Code and grabbed the design philosophy of <code class="docutils literal"><span class="pre">DArray</span></code> in Majel.</p>
<div class="section" id="memory-management">
<span id="memory-management"></span><h3>Memory Management<a class="headerlink" href="#memory-management" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal"><span class="pre">Allocation</span></code> manages a block of memory in device(CPU/GPU). We use <code class="docutils literal"><span class="pre">Place</span></code> to decribe memory location. The details of memory allocation and deallocation are implememted in <code class="docutils literal"><span class="pre">Allocator</span></code> and <code class="docutils literal"><span class="pre">DeAllocator</span></code>. Related low-level API such as <code class="docutils literal"><span class="pre">hl_malloc_device()</span></code> and <code class="docutils literal"><span class="pre">hl_malloc_host()</span></code> are provided by Paddle.</p>
</div>
<div class="section" id="dim-and-array">
<span id="dim-and-array"></span><h3>Dim and Array<a class="headerlink" href="#dim-and-array" title="永久链接至标题">¶</a></h3>
<div class="section" id="dim">
<span id="dim"></span><h4>Dim<a class="headerlink" href="#dim" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Dim</span></code> decribes the dimension information of an array.</p>
<p><code class="docutils literal"><span class="pre">DDimVar</span></code> is an alias of a specializd class of boost.variant class template.</p>
<p><code class="docutils literal"><span class="pre">DDim</span></code> is introduced to represent a dynamically sized dimension.</p>
<p>For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Dim</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">make_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">DDim</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">make_ddim</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">});</span>
</pre></div>
</div>
<p>You must appoint a concrete sized dimension to Dim, whereas DDim can represent a dynamically sized dimension.</p>
</div>
<div class="section" id="array">
<span id="array"></span><h4>Array<a class="headerlink" href="#array" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Array</span></code> represents for a tensor with specific type and size.</p>
<p><code class="docutils literal"><span class="pre">DArrarVar</span></code> is an alias of a specialized class of boost.variant class template.</p>
<p><code class="docutils literal"><span class="pre">DArray</span></code> is introduced to represent a dynamically typed array.</p>
<p>For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Array</span><span class="o">&lt;</span><span class="nb">float</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">a1</span><span class="p">(</span><span class="n">Dim</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="n">DArray</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">make_darray</span><span class="p">(</span><span class="n">make_ddim</span><span class="p">({</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">}),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">CpuPlace</span><span class="p">());</span>
</pre></div>
</div>
<p>You must appoint the type and dimension of a Array, whereas DArray can represent a dynanmically typed array.</p>
<p>Please reference the section of <code class="docutils literal"><span class="pre">Learn</span> <span class="pre">from</span> <span class="pre">Majel</span></code> for more details.</p>
</div>
</div>
<div class="section" id="arrayview">
<span id="arrayview"></span><h3>ArrayView<a class="headerlink" href="#arrayview" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal"><span class="pre">ViewIterator</span></code> is a class template which implements basic iterator operation, including increment(++), decrement(–), dereference(*), equality comparisons(==) and so on.</p>
<p><code class="docutils literal"><span class="pre">ArrayView</span></code> is an encapsulation of <code class="docutils literal"><span class="pre">Array</span></code>， which introduces extra iterator methods, such as <code class="docutils literal"><span class="pre">begin()</span></code> and <code class="docutils literal"><span class="pre">end()</span></code>. The <code class="docutils literal"><span class="pre">begin()</span></code> method returns an iterator pointing to the first element in the ArrayView. And the <code class="docutils literal"><span class="pre">end()</span></code> method returns an iterator pointing to the pass-the-end element in the ArrayView.</p>
<p><code class="docutils literal"><span class="pre">ArrayView</span></code> make the visting and manipulating an array more efficiently, flexibly and safely.</p>
<p>A global function <code class="docutils literal"><span class="pre">make_view</span></code> is provided to transform an array to corresponding arrayview.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="n">T</span><span class="p">,</span> <span class="nb">int</span> <span class="n">D</span><span class="o">&gt;</span>
<span class="n">ArrayView</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">D</span><span class="o">&gt;</span> <span class="n">make_view</span><span class="p">(</span><span class="n">const</span> <span class="n">Array</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">D</span><span class="o">&gt;&amp;</span> <span class="ow">in</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="ow">in</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A global function <code class="docutils literal"><span class="pre">make_iterator</span></code> is provided to make iterator of an array.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="n">T</span><span class="p">,</span> <span class="nb">int</span> <span class="n">D</span><span class="o">&gt;</span>
<span class="n">ViewIterator</span><span class="o">&lt;</span><span class="n">ArrayView</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">D</span><span class="o">&gt;&gt;</span> <span class="n">make_iterator</span><span class="p">(</span><span class="n">const</span> <span class="n">Array</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">D</span><span class="o">&gt;&amp;</span> <span class="ow">in</span><span class="p">,</span> <span class="n">Dim</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">make_iterator</span><span class="p">(</span><span class="n">make_view</span><span class="p">(</span><span class="ow">in</span><span class="p">),</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="basic-operations">
<span id="basic-operations"></span><h3>Basic Operations<a class="headerlink" href="#basic-operations" title="永久链接至标题">¶</a></h3>
<p>The operations that manipulate DArray are defined as global functions, such as <code class="docutils literal"><span class="pre">ones</span></code>, <code class="docutils literal"><span class="pre">zeros</span></code>, <code class="docutils literal"><span class="pre">reshape</span></code>, <code class="docutils literal"><span class="pre">gemm</span></code> and so on.</p>
<p>An array will be trasformed into an arrayview and then passed to the operation launching on a specific device(CPU/GPU).</p>
</div>
</div>
</div>
</div>
<div class="articleComments">
</div>
</div>