<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="survey-on-graph">
<span id="survey-on-graph"></span><h1>Survey on Graph<a class="headerlink" href="#survey-on-graph" title="永久链接至标题">¶</a></h1>
<p>Neural network framework often provides symbolic API for users to write network topology conveniently. This doc manily focus on symbolic API in most popular neural network frameworks, and try to find out how to parse symbolic configuration to a portable file, such as protobuf or json.</p>
<div class="section" id="mxnet">
<span id="mxnet"></span><h2>Mxnet<a class="headerlink" href="#mxnet" title="永久链接至标题">¶</a></h2>
<p>The core concept of symbolic API is <code class="docutils literal"><span class="pre">Symbol</span></code>. Mxnet implements <code class="docutils literal"><span class="pre">Symbol</span></code> class in C++, and export to Python using C-API. Please refer to the comments in Mxnet:</p>
<p><code class="docutils literal"><span class="pre">Symbol</span></code> is help class used to represent the operator node in Graph.
<code class="docutils literal"><span class="pre">Symbol</span></code> acts as an interface for building graphs from different components like Variable, Functor and Group. <code class="docutils literal"><span class="pre">Symbol</span></code> is also exported to python front-end (while Graph is not) to enable quick test and deployment. Conceptually, symbol is the final operation of a graph and thus including all the information required (the graph) to evaluate its output value.</p>
<p>A simple network topology wrote by Symbol is as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_symbol</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">'data'</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">fc1</span>  <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">FullyConnected</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'fc1'</span><span class="p">,</span> <span class="n">num_hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">act1</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">fc1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'relu1'</span><span class="p">,</span> <span class="n">act_type</span><span class="o">=</span><span class="s2">"relu"</span><span class="p">)</span>
    <span class="n">fc2</span>  <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">FullyConnected</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">act1</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'fc2'</span><span class="p">,</span> <span class="n">num_hidden</span> <span class="o">=</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">act2</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">fc2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'relu2'</span><span class="p">,</span> <span class="n">act_type</span><span class="o">=</span><span class="s2">"relu"</span><span class="p">)</span>
    <span class="n">fc3</span>  <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">FullyConnected</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">act2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'fc3'</span><span class="p">,</span> <span class="n">num_hidden</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>
    <span class="n">mlp</span>  <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">SoftmaxOutput</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">fc3</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'softmax'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mlp</span>
</pre></div>
</div>
<p>Varible here is actually a Symbol. Every basic Symbol will correspond to one Node, and every Node has its own NodeAttr. There is a op field in NodeAttr class, when a Symbol represents Variable(often input data), the op field is null.</p>
<p>Symbol contains a data member, std::vector<nodeentry> outputs, and NodeEntry cantains a poniter to Node. We can follow the Node pointer to get all the Graph.</nodeentry></p>
<p>And Symbol can be saved to a Json file.</p>
<p>Here is a detailed example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">mxnet</span> <span class="k">as</span> <span class="nn">mx</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">'data'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">data</span><span class="o">.</span><span class="n">debug_str</span><span class="p">()</span>
<span class="go">Variable:data</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">data</span><span class="o">.</span><span class="n">debug_str</span><span class="p">()</span>
<span class="go">Symbol Outputs:</span>
<span class="go">    output[0]=flatten0(0)</span>
<span class="go">Variable:data</span>
<span class="go">--------------------</span>
<span class="go">Op:Flatten, Name=flatten0</span>
<span class="go">Inputs:</span>
<span class="go">    arg[0]=data(0) version=0</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">fc1</span>  <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">FullyConnected</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'fc1'</span><span class="p">,</span> <span class="n">num_hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">fc1</span><span class="o">.</span><span class="n">debug_str</span><span class="p">()</span>
<span class="go">Symbol Outputs:</span>
<span class="go">    output[0]=fc1(0)</span>
<span class="go">Variable:data</span>
<span class="go">--------------------</span>
<span class="go">Op:Flatten, Name=flatten0</span>
<span class="go">Inputs:</span>
<span class="go">    arg[0]=data(0) version=0</span>
<span class="go">Variable:fc1_weight</span>
<span class="go">Variable:fc1_bias</span>
<span class="go">--------------------</span>
<span class="go">Op:FullyConnected, Name=fc1</span>
<span class="go">Inputs:</span>
<span class="go">    arg[0]=flatten0(0)</span>
<span class="go">    arg[1]=fc1_weight(0) version=0</span>
<span class="go">    arg[2]=fc1_bias(0) version=0</span>
<span class="go">Attrs:</span>
<span class="go">    num_hidden=128</span>
</pre></div>
</div>
</div>
<div class="section" id="tensorflow">
<span id="tensorflow"></span><h2>TensorFlow<a class="headerlink" href="#tensorflow" title="永久链接至标题">¶</a></h2>
<p>The core concept of symbolic API is <code class="docutils literal"><span class="pre">Tensor</span></code>. Tensorflow defines <code class="docutils literal"><span class="pre">Tensor</span></code> in Python. Please refer to the comments in TensorFlow:</p>
<p>A <code class="docutils literal"><span class="pre">Tensor</span></code> is a symbolic handle to one of the outputs of an <code class="docutils literal"><span class="pre">Operation</span></code>. It does not hold the values of that operation’s output, but instead provides a means of computing those values in a TensorFlow <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/Session">Session</a>.</p>
<p>A simple example is as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>  <span class="c1"># Build a dataflow graph.</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">]])</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
  <span class="n">e</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

  <span class="c1"># Construct a `Session` to execute the graph.</span>
  <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

  <span class="c1"># Execute the graph and store the value that `e` represents in `result`.</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>The main method of <code class="docutils literal"><span class="pre">Tensor</span></code> is as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="sd">"""The `Operation` that produces this tensor as an output."""</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span>

<span class="nd">@property</span>
<span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
   <span class="sd">"""The `DType` of elements in this tensor."""</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span>

<span class="nd">@property</span>
<span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="sd">"""The `Graph` that contains this tensor."""</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">graph</span>

<span class="nd">@property</span>
<span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="sd">"""The string name of this tensor."""</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Operation was not named: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">)</span>
  <span class="k">return</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_index</span><span class="p">)</span>

<span class="nd">@property</span>
<span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="sd">"""The name of the device on which this tensor will be produced, or None."""</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">device</span>
</pre></div>
</div>
<p>Tensor can be taken as target to run by session. Tensor contains all the information of Graph, and tracks data dependency.</p>
<p>Here is a detailed example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">c</span><span class="o">.</span><span class="n">graph</span>
<span class="go">&lt;tensorflow.python.framework.ops.Graph object at 0x10f256d50&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">d</span><span class="o">.</span><span class="n">graph</span>
<span class="go">&lt;tensorflow.python.framework.ops.Graph object at 0x10f256d50&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">e</span><span class="o">.</span><span class="n">graph</span>
<span class="go">&lt;tensorflow.python.framework.ops.Graph object at 0x10f256d50&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="dynet">
<span id="dynet"></span><h2>Dynet<a class="headerlink" href="#dynet" title="永久链接至标题">¶</a></h2>
<p>The core concept of symbolic API is <code class="docutils literal"><span class="pre">Expression</span></code>, and Dynet defines <code class="docutils literal"><span class="pre">Expression</span></code> class in C++.</p>
<p>A simple example is as follows:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">ComputationGraph</span> <span class="n">cg</span><span class="p">;</span>
<span class="n">Expression</span> <span class="n">W</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">pW</span><span class="p">);</span>

<span class="n">Expression</span> <span class="n">in</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">Expression</span> <span class="n">label</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">Expression</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">W</span> <span class="o">*</span> <span class="n">in</span><span class="p">;</span>
<span class="n">Expression</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">square</span><span class="p">(</span><span class="n">pred</span> <span class="o">-</span> <span class="n">label</span><span class="p">);</span>
</pre></div>
</div>
<p>The input data and parameter are also represented by Expression. Every basci Expression corresponds to a Node. And input data is also a Node.</p>
<p>Expression has a data member ComputationGraph, and ComputationGraph will be modified in users’ configuring process. Expression can be a running target, beacuse Expression contains all dependency.</p>
<p>Here is a detailed example:</p>
<p>write topology in C++</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ComputationGraph</span> <span class="n">cg</span><span class="p">;</span>
<span class="n">Expression</span> <span class="n">W</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">pW</span><span class="p">);</span>
<span class="n">cg</span><span class="o">.</span><span class="n">print_graphviz</span><span class="p">();</span>

<span class="n">Expression</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">W</span> <span class="o">*</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="n">cg</span><span class="o">.</span><span class="n">print_graphviz</span><span class="p">();</span>

<span class="n">Expression</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">square</span><span class="p">(</span><span class="n">pred</span> <span class="o">-</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">cg</span><span class="o">.</span><span class="n">print_graphviz</span><span class="p">();</span>
</pre></div>
</div>
<p>compile and print</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># first print</span>
<span class="n">digraph</span> <span class="n">G</span> <span class="p">{</span>
  <span class="n">rankdir</span><span class="o">=</span><span class="n">LR</span><span class="p">;</span>
  <span class="n">nodesep</span><span class="o">=.</span><span class="mi">05</span><span class="p">;</span>
  <span class="n">N0</span> <span class="p">[</span><span class="n">label</span><span class="o">=</span><span class="s2">"v0 = parameters(</span><span class="si">{1}</span><span class="s2">) @ 0x7ffe4de00110"</span><span class="p">];</span>
<span class="p">}</span>
<span class="c1"># second print</span>
<span class="n">digraph</span> <span class="n">G</span> <span class="p">{</span>
  <span class="n">rankdir</span><span class="o">=</span><span class="n">LR</span><span class="p">;</span>
  <span class="n">nodesep</span><span class="o">=.</span><span class="mi">05</span><span class="p">;</span>
  <span class="n">N0</span> <span class="p">[</span><span class="n">label</span><span class="o">=</span><span class="s2">"v0 = parameters(</span><span class="si">{1}</span><span class="s2">) @ 0x7ffe4de00110"</span><span class="p">];</span>
  <span class="n">N1</span> <span class="p">[</span><span class="n">label</span><span class="o">=</span><span class="s2">"v1 = v0 * -0.98"</span><span class="p">];</span>
  <span class="n">N0</span> <span class="o">-&gt;</span> <span class="n">N1</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1"># third print</span>
<span class="n">digraph</span> <span class="n">G</span> <span class="p">{</span>
  <span class="n">rankdir</span><span class="o">=</span><span class="n">LR</span><span class="p">;</span>
  <span class="n">nodesep</span><span class="o">=.</span><span class="mi">05</span><span class="p">;</span>
  <span class="n">N0</span> <span class="p">[</span><span class="n">label</span><span class="o">=</span><span class="s2">"v0 = parameters(</span><span class="si">{1}</span><span class="s2">) @ 0x7ffe4de00110"</span><span class="p">];</span>
  <span class="n">N1</span> <span class="p">[</span><span class="n">label</span><span class="o">=</span><span class="s2">"v1 = v0 * -0.98"</span><span class="p">];</span>
  <span class="n">N0</span> <span class="o">-&gt;</span> <span class="n">N1</span><span class="p">;</span>
  <span class="n">N2</span> <span class="p">[</span><span class="n">label</span><span class="o">=</span><span class="s2">"v2 = -1.88387 - v1"</span><span class="p">];</span>
  <span class="n">N1</span> <span class="o">-&gt;</span> <span class="n">N2</span><span class="p">;</span>
  <span class="n">N3</span> <span class="p">[</span><span class="n">label</span><span class="o">=</span><span class="s2">"v3 = -v2"</span><span class="p">];</span>
  <span class="n">N2</span> <span class="o">-&gt;</span> <span class="n">N3</span><span class="p">;</span>
  <span class="n">N4</span> <span class="p">[</span><span class="n">label</span><span class="o">=</span><span class="s2">"v4 = square(v3)"</span><span class="p">];</span>
  <span class="n">N3</span> <span class="o">-&gt;</span> <span class="n">N4</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<span id="conclusion"></span><h2>Conclusion<a class="headerlink" href="#conclusion" title="永久链接至标题">¶</a></h2>
<p>Actually, Symbol/Tensor/Expression in Mxnet/TensorFlow/Dynet are the same level concepts. We use a unified name Expression here, this level concept has following features:</p>
<ul class="simple">
<li>Users wirte topoloy with symbolic API, and all return value is Expression, including input data and parameter.</li>
<li>Expression corresponds with a global Graph, and Expression can also be composed.</li>
<li>Expression tracks all dependency and can be taken as a run target</li>
</ul>
</div>
</div>
</div>
<div class="articleComments">
</div>
</div>