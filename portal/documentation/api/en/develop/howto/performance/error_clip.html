<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="error-clip">
<span id="error-clip"></span><h1>Error Clip<a class="headerlink" href="#error-clip" title="永久链接至标题">¶</a></h1>
<div class="section" id="overview">
<span id="overview"></span><h2>Overview<a class="headerlink" href="#overview" title="永久链接至标题">¶</a></h2>
<p>Error clip is widely used in model training to prevent gradient exploding. It takes some specific rules to adjust variables’ gradients and prevent them from being too large. With it, values of a gradient will be checked before they are taken by the next <code class="docutils literal"><span class="pre">grad_op</span></code> and be shrunk if necessary.</p>
</div>
<div class="section" id="usage">
<span id="usage"></span><h2>Usage<a class="headerlink" href="#usage" title="永久链接至标题">¶</a></h2>
<p>Users are allowed to assign different error clip methods or attributes to different <code class="docutils literal"><span class="pre">Variable</span></code>s. Users can specify it as a parameter of <code class="docutils literal"><span class="pre">Variable</span></code>‘s constructor:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="o">=</span> <span class="n">framework</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">error_clip</span><span class="o">=</span><span class="n">myErrorClip</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>The default value of <code class="docutils literal"><span class="pre">error_clip</span></code> is <code class="docutils literal"><span class="pre">None</span></code>, which means no error clip is employed. When it’s not <code class="docutils literal"><span class="pre">None</span></code>, it should take an object of <code class="docutils literal"><span class="pre">BaseErrorClipAttr</span></code>‘s derived class. So far, <code class="docutils literal"><span class="pre">BaseErrorClipAttr</span></code> has only one derived class: <code class="docutils literal"><span class="pre">ErrorClipByValue</span></code>, whose constructor is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ErrorClipByValue</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">max</span></code> and <code class="docutils literal"><span class="pre">min</span></code> represent the maximal and minimal clip threshold respectively. In backward pass, all values of <code class="docutils literal"><span class="pre">var</span></code>‘s gradient greater than <code class="docutils literal"><span class="pre">max</span></code> or less than <code class="docutils literal"><span class="pre">min</span></code> will be clipped to <code class="docutils literal"><span class="pre">max</span></code> and <code class="docutils literal"><span class="pre">min</span></code> respectively. When the <code class="docutils literal"><span class="pre">min</span></code> is None, the minimal threshold will be assigned with <code class="docutils literal"><span class="pre">-max</span></code> automatically.</p>
<p>So we can enable the error clip with threshold <code class="docutils literal"><span class="pre">[-5.0,</span> <span class="pre">5.0]</span></code> for variable <code class="docutils literal"><span class="pre">var</span></code> by:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="o">=</span> <span class="n">framework</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">error_clip</span><span class="o">=</span><span class="n">ErrorClipByValue</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">5.0</span><span class="p">),</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="implementation">
<span id="implementation"></span><h2>Implementation<a class="headerlink" href="#implementation" title="永久链接至标题">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">BaseErrorClipAttr</span></code> and its derived class <code class="docutils literal"><span class="pre">ErrorClipByValue</span></code> are defined in <em>clip.py</em>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseErrorClipAttr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">append_clip_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">grad_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ErrorClipByValue</span><span class="p">(</span><span class="n">BaseErrorClipAttr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">min</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nb">min</span> <span class="o">=</span> <span class="o">-</span><span class="nb">max</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="nb">max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="nb">min</span>

    <span class="k">def</span> <span class="nf">append_clip_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">grad_name</span><span class="p">):</span>
        <span class="n">clip_op_desc</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">desc</span><span class="o">.</span><span class="n">append_op</span><span class="p">()</span>
        <span class="n">clip_op_desc</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="s2">"clip"</span><span class="p">)</span>
        <span class="n">clip_op_desc</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="s2">"X"</span><span class="p">,</span> <span class="p">[</span><span class="n">grad_name</span><span class="p">])</span>
        <span class="n">clip_op_desc</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s2">"Out"</span><span class="p">,</span> <span class="p">[</span><span class="n">grad_name</span><span class="p">])</span>
        <span class="n">clip_op_desc</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="s2">"min"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
        <span class="n">clip_op_desc</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="s2">"max"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">BaseErrorClipAttr</span></code> have one main member functions: <code class="docutils literal"><span class="pre">append_clip_op(self,</span> <span class="pre">block,</span> <span class="pre">grad_name)</span></code>.</p>
<p>This function is used to create a <code class="docutils literal"><span class="pre">clip_op</span></code> and append it to the end of given <code class="docutils literal"><span class="pre">block</span></code>. For different error clip algorithm require different <code class="docutils literal"><span class="pre">clip_op</span></code>, the function is defined as virtual in the base class. All derived classes must implement their own versions of this function.</p>
<p>These <code class="docutils literal"><span class="pre">clip_op</span></code>s should be inserted after <code class="docutils literal"><span class="pre">grad_op</span></code>s whose output gradients need to be clipped. It is equivalent to appending some <code class="docutils literal"><span class="pre">clip_op</span></code>s to the end of the target block every time a new <code class="docutils literal"><span class="pre">grad_op</span></code> is added.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">op_desc</span> <span class="ow">in</span> <span class="n">grad_op_descs</span><span class="p">:</span>
        <span class="n">new_op_desc</span> <span class="o">=</span> <span class="n">target_block</span><span class="o">.</span><span class="n">desc</span><span class="o">.</span><span class="n">append_op</span><span class="p">()</span>
        <span class="n">new_op_desc</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">op_desc</span><span class="p">)</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">target_block</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">grad_to_var</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we employ a callback function to complete this kind of jobs. In <code class="docutils literal"><span class="pre">_append_backward_ops_</span></code> function, each time after a <code class="docutils literal"><span class="pre">grad_op</span></code> is added to the <code class="docutils literal"><span class="pre">target_block</span></code>, a callback function is invoked. The logic of <code class="docutils literal"><span class="pre">clip_op</span></code> appending can be implemented inside the callback function.</p>
<p>The callback function for <code class="docutils literal"><span class="pre">clip_op</span></code> appending is defined in <em>clip.py</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">error_clip_callback</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># the context is a grad_to_var map</span>
    <span class="n">grad_to_var</span> <span class="o">=</span> <span class="n">context</span>
    <span class="n">op_desc</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">desc</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">desc</span><span class="o">.</span><span class="n">op_size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">grad_n</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">grad_to_var</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">n</span><span class="p">),</span>
                         <span class="n">op_desc</span><span class="o">.</span><span class="n">output_arg_names</span><span class="p">()):</span>
        <span class="n">fwd_var</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">var_recursive</span><span class="p">(</span><span class="n">grad_to_var</span><span class="p">[</span><span class="n">grad_n</span><span class="p">])</span>
        <span class="n">error_clip</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fwd_var</span><span class="p">,</span> <span class="s2">"error_clip"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">error_clip</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error_clip</span><span class="p">,</span>
                                                 <span class="n">BaseErrorClipAttr</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">"Variable's error_clip should be an instance of BaseErrorClipAttr or None."</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">error_clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">error_clip</span><span class="o">.</span><span class="n">append_clip_op</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">grad_n</span><span class="p">)</span>
</pre></div>
</div>
<p>This function takes a <code class="docutils literal"><span class="pre">block</span></code> and a <code class="docutils literal"><span class="pre">context</span></code>(which is actually a grad_to_var map) as inputs. It checks each output of the last <code class="docutils literal"><span class="pre">OpDesc</span></code> in the <code class="docutils literal"><span class="pre">block</span></code>. Notice that the last <code class="docutils literal"><span class="pre">OpDesc</span></code> of the <code class="docutils literal"><span class="pre">block</span></code> must be a <code class="docutils literal"><span class="pre">grad_op</span></code> and its outputs must be some forward variables’ gradients. If an output gradient’s corresponding forward variable has an attribute of <code class="docutils literal"><span class="pre">error_clip</span></code>, <code class="docutils literal"><span class="pre">error_clip_callback</span></code> will call the <code class="docutils literal"><span class="pre">error_clip</span></code>‘s <code class="docutils literal"><span class="pre">append_clip_op</span></code> function to append the required <code class="docutils literal"><span class="pre">clip_op</span></code> into the <code class="docutils literal"><span class="pre">block</span></code>.</p>
</div>
</div>
</div>
<div class="articleComments">
</div>
</div>