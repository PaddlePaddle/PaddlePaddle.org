<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="go-op-design">
<span id="go-op-design"></span><h1>go_op Design<a class="headerlink" href="#go-op-design" title="永久链接至标题">¶</a></h1>
<div class="section" id="introduction">
<span id="introduction"></span><h2>Introduction<a class="headerlink" href="#introduction" title="永久链接至标题">¶</a></h2>
<p>The <strong>go_op</strong> allows user’s of PaddlePaddle to run program blocks on a detached
thread.  It works in conjuction with CSP operators (channel_send,
channel_receive, channel_open, channel_close, and select) to allow users to
concurrently process data and communicate easily between different threads.</p>
</div>
<div class="section" id="how-to-use-it">
<span id="how-to-use-it"></span><h2>How to use it<a class="headerlink" href="#how-to-use-it" title="永久链接至标题">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">channel</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">make_channel</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">LOD_TENSOR</span><span class="p">)</span>

<span class="k">with</span> <span class="n">fluid</span><span class="o">.</span><span class="n">Go</span><span class="p">():</span>
    <span class="c1"># Send a tensor of value 99 to "channel" on a detached thread</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">fill_constant</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'int'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">tensor</span><span class="o">.</span><span class="n">stop_gradient</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">fluid</span><span class="o">.</span><span class="n">channel_send</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
    
<span class="c1"># Receive sent tensor from "channel" on the main thread</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">fill_constant</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'int'</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>    
<span class="n">fluid</span><span class="o">.</span><span class="n">channel_recv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>  
</pre></div>
</div>
<p>The go operator can be accessed by using the fluid.Go() control flow.  This
will create a new sub block, where the user can add additional operators
to be ran on the thread.</p>
<p><strong>Note:</strong> Since back propegation is currently not support in the go_op, users
should ensure that operators in the go block does not require gradient
calculations.</p>
</div>
<div class="section" id="how-it-works">
<span id="how-it-works"></span><h2>How it Works<a class="headerlink" href="#how-it-works" title="永久链接至标题">¶</a></h2>
<p>Similar to other control blocks, go_op will create a sub block and add it
as a child to the current block.  Operators and variables defined in this
block will be added to the go sub_block.</p>
<p>In addition, the go operator will create a new child scope whose parent is
the global scope.  Please refer to <a class="reference external" href="#block-captures">block captures</a> for more
information.</p>
<p>When Paddle executor runs go_op, go_op will take the sub_block and pass it to
the executor.run method (along with a newly created local scope) on a detached
thread.</p>
<p>An example of the generated program description is shown below.  Take note of
the <strong>go_op</strong> in particular.  It is added as an operator in the current
block (in this example, block0).  The <strong>go_op</strong> contains a <code class="docutils literal"><span class="pre">sub_block</span></code>
attribute, which points to the id of the block that will be executed in a
detached thread.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">blocks</span> <span class="p">{</span>
  <span class="n">idx</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">parent_idx</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
  <span class="nb">vars</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">"return_value"</span>
    <span class="nb">type</span> <span class="p">{</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">LOD_TENSOR</span>
      <span class="n">lod_tensor</span> <span class="p">{</span>
        <span class="n">tensor</span> <span class="p">{</span>
          <span class="n">data_type</span><span class="p">:</span> <span class="n">INT64</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nb">vars</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">"status_recv"</span>
    <span class="nb">type</span> <span class="p">{</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">LOD_TENSOR</span>
      <span class="n">lod_tensor</span> <span class="p">{</span>
        <span class="n">tensor</span> <span class="p">{</span>
          <span class="n">data_type</span><span class="p">:</span> <span class="n">BOOL</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="o">...</span>
  <span class="n">ops</span> <span class="p">{</span>
    <span class="n">outputs</span> <span class="p">{</span>
      <span class="n">parameter</span><span class="p">:</span> <span class="s2">"Out"</span>
      <span class="n">arguments</span><span class="p">:</span> <span class="s2">"channel"</span>
    <span class="p">}</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">"channel_create"</span>
    <span class="n">attrs</span> <span class="p">{</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">"data_type"</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">INT</span>
      <span class="n">i</span><span class="p">:</span> <span class="mi">7</span>
    <span class="p">}</span>
    <span class="n">attrs</span> <span class="p">{</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">"capacity"</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">INT</span>
      <span class="n">i</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">ops</span> <span class="p">{</span>
    <span class="n">inputs</span> <span class="p">{</span>
      <span class="n">parameter</span><span class="p">:</span> <span class="s2">"X"</span>
      <span class="n">arguments</span><span class="p">:</span> <span class="s2">"channel"</span>
    <span class="p">}</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">"go"</span>
    <span class="n">attrs</span> <span class="p">{</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">"sub_block"</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">BLOCK</span>
      <span class="n">block_idx</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">ops</span> <span class="p">{</span>
    <span class="n">inputs</span> <span class="p">{</span>
      <span class="n">parameter</span><span class="p">:</span> <span class="s2">"Channel"</span>
      <span class="n">arguments</span><span class="p">:</span> <span class="s2">"channel"</span>
    <span class="p">}</span>
    <span class="n">outputs</span> <span class="p">{</span>
      <span class="n">parameter</span><span class="p">:</span> <span class="s2">"Out"</span>
      <span class="n">arguments</span><span class="p">:</span> <span class="s2">"return_value"</span>
    <span class="p">}</span>
    <span class="n">outputs</span> <span class="p">{</span>
      <span class="n">parameter</span><span class="p">:</span> <span class="s2">"Status"</span>
      <span class="n">arguments</span><span class="p">:</span> <span class="s2">"status_recv"</span>
    <span class="p">}</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">"channel_recv"</span>
  <span class="p">}</span>
  <span class="o">...</span>
<span class="p">}</span>

<span class="n">blocks</span> <span class="p">{</span>
  <span class="n">idx</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">parent_idx</span><span class="p">:</span> <span class="mi">0</span>
  <span class="nb">vars</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">"status"</span>
    <span class="nb">type</span> <span class="p">{</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">LOD_TENSOR</span>
      <span class="n">lod_tensor</span> <span class="p">{</span>
        <span class="n">tensor</span> <span class="p">{</span>
          <span class="n">data_type</span><span class="p">:</span> <span class="n">BOOL</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="o">...</span>
  
  <span class="n">ops</span> <span class="p">{</span>
    <span class="n">outputs</span> <span class="p">{</span>
      <span class="n">parameter</span><span class="p">:</span> <span class="s2">"Out"</span>
      <span class="n">arguments</span><span class="p">:</span> <span class="s2">"fill_constant_1.tmp_0"</span>
    <span class="p">}</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">"fill_constant"</span>
    <span class="n">attrs</span> <span class="p">{</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">"force_cpu"</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">BOOLEAN</span>
      <span class="n">b</span><span class="p">:</span> <span class="n">false</span>
    <span class="p">}</span>
    <span class="n">attrs</span> <span class="p">{</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">"value"</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">FLOAT</span>
      <span class="n">f</span><span class="p">:</span> <span class="mf">99.0</span>
    <span class="p">}</span>
    <span class="n">attrs</span> <span class="p">{</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">"shape"</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">INTS</span>
      <span class="n">ints</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
    <span class="n">attrs</span> <span class="p">{</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">"dtype"</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">INT</span>
      <span class="n">i</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">ops</span> <span class="p">{</span>
    <span class="n">inputs</span> <span class="p">{</span>
      <span class="n">parameter</span><span class="p">:</span> <span class="s2">"Channel"</span>
      <span class="n">arguments</span><span class="p">:</span> <span class="s2">"channel"</span>
    <span class="p">}</span>
    <span class="n">inputs</span> <span class="p">{</span>
      <span class="n">parameter</span><span class="p">:</span> <span class="s2">"X"</span>
      <span class="n">arguments</span><span class="p">:</span> <span class="s2">"fill_constant_1.tmp_0"</span>
    <span class="p">}</span>
    <span class="n">outputs</span> <span class="p">{</span>
      <span class="n">parameter</span><span class="p">:</span> <span class="s2">"Status"</span>
      <span class="n">arguments</span><span class="p">:</span> <span class="s2">"status"</span>
    <span class="p">}</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">"channel_send"</span>
    <span class="n">attrs</span> <span class="p">{</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">"copy"</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">BOOLEAN</span>
      <span class="n">b</span><span class="p">:</span> <span class="n">false</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="current-limitations">
<span id="current-limitations"></span><h2>Current Limitations<a class="headerlink" href="#current-limitations" title="永久链接至标题">¶</a></h2>
<div class="section" id="a-name-block-captures-a-scopes-and-block-captures">
<span id="a-name-block-captures-a-scopes-and-block-captures"></span><h3><a name="block-captures"></a>Scopes and block captures:<a class="headerlink" href="#a-name-block-captures-a-scopes-and-block-captures" title="永久链接至标题">¶</a></h3>
<p>Paddle utilizes <a class="reference internal" href="../concepts/scope.html"><span class="doc">scopes</span></a> to store variables used in a
block.  When a block is executed, a new local scope is created from the parent
scope (ie: scope derived from the parent block) and associated with the new
child block.  After the block finishes executing, then the local scope and
all associated variables in the scope is deleted.</p>
<p>This works well in a single threaded scenario, however with introduction of
go_op, a child block may continue to execute even after the parent block has
exited.  If the go_op tries to access variables located in the parent block’s
scope, it may receive a segmentation fault because the parent scope may have
been deleted.</p>
<p>We need to implement block closures in order to prevent access to parent
scope variables from causing a segmentation fault.  As a temporary workaround,
please ensure that all variables accessed in the go block is not destructed
before it is being accessed.  Currently, the go_op will explicitly enforce
this requirement and raise an exception if a variable could not be found in
the scope.</p>
<p>Please refer to <a class="reference external" href="https://github.com/PaddlePaddle/Paddle/issues/8502">Closure issue</a>
for more details.</p>
</div>
<div class="section" id="green-threads">
<span id="green-threads"></span><h3>Green Threads<a class="headerlink" href="#green-threads" title="永久链接至标题">¶</a></h3>
<p>Golang utilizes <code class="docutils literal"><span class="pre">green</span> <span class="pre">threads</span></code>, which is a mechnism for the runtime library to
manage multiple threads (instead of natively by the OS).  Green threads usually
allows for faster thread creation and switching, as there is less overhead
when spawning these threads.  For the first version of CSP, we only support
OS threads.</p>
</div>
<div class="section" id="backward-propegation">
<span id="backward-propegation"></span><h3>Backward Propegation:<a class="headerlink" href="#backward-propegation" title="永久链接至标题">¶</a></h3>
<p>go_op currently does not support backwards propagation.  Please use go_op with
non training operators.</p>
</div>
</div>
</div>
</div>
<div class="articleComments">
</div>
</div>