<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="design-doc-functions-operators-and-layers">
<span id="design-doc-functions-operators-and-layers"></span><h1>Design Doc: Functions, Operators, and Layers<a class="headerlink" href="#design-doc-functions-operators-and-layers" title="永久链接至标题">¶</a></h1>
<p>In a DL system, we can compose one or more fine grained operators into a coarse grained one.  For example, the FC layer can be composed of a multiplication operator and an add operator.</p>
<p>Historically, some fine grained operations are known as operators, and some coarse level ones are known as layers.  But we need a well-defined separation.</p>
<p>In general, operators are those very fine grained operations, e.g., mul and add. In the implementation, we can write them as C++ functions:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">add</span><span class="p">(</span><span class="n">T</span> <span class="n">x</span><span class="p">,</span> <span class="n">T</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">;</span> <span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">mul</span><span class="p">(</span><span class="n">T</span> <span class="n">x</span><span class="p">,</span> <span class="n">T</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>Then we can wrap them into operators which are C++ classes and can be created from Python bindings by name.  A C macro can do this. For example, the following macro invocation</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="cp">#define MAKE_FUNCTION_OPERATOR(mul);</span>
</pre></div>
</div>
<p>generates</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">mulOp</span> <span class="o">:</span> <span class="k">public</span> <span class="n">OperatorBase</span> <span class="p">{...};</span>
<span class="n">REGISTER_OP</span><span class="p">(</span><span class="n">mulOp</span><span class="o">&lt;</span><span class="n">float32</span><span class="o">&gt;</span><span class="p">,</span> <span class="s">"mul"</span><span class="p">);</span>
</pre></div>
</div>
<p>so that in Python we can create operator mul by:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">X1</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
<span class="n">X2</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
<span class="n">paddle</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span><span class="n">create_operator</span><span class="p">(</span><span class="s2">"mul"</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="n">Y</span><span class="p">)</span>
</pre></div>
</div>
<p>Also, at the same time, we can compose a coarse level C++ operator class by composing functions <code class="docutils literal"><span class="pre">mul</span></code> and <code class="docutils literal"><span class="pre">add</span></code>:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">FCOp</span> <span class="o">:</span> <span class="k">public</span> <span class="n">OperatorBase</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">Run</span><span class="p">(...)</span> <span class="p">{</span>
    <span class="n">add</span><span class="p">(</span><span class="n">mul</span><span class="p">(</span><span class="n">Input</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"X"</span><span class="p">),</span> <span class="n">Input</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"W"</span><span class="p">)),</span> <span class="n">Input</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"b"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="n">REGISTER_OP</span><span class="p">(</span><span class="n">FCOp</span><span class="p">,</span> <span class="s">"fc"</span><span class="p">);</span>
</pre></div>
</div>
<p>We need to support such composition in Python as well.  To do so, we need a higher level Python wrapping of operator creation than <code class="docutils literal"><span class="pre">paddle.cpp.create_operator</span></code>.  This higher level operator API should be compatible with the layer API.</p>
<p>Let’s explain using an example.  Suppose that we are going to compose the FC using mul and add in Python, we’d like to have Python functions <code class="docutils literal"><span class="pre">mul</span></code> and <code class="docutils literal"><span class="pre">add</span></code> defined in module <code class="docutils literal"><span class="pre">operator</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">):</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
    <span class="n">paddle</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span><span class="n">create_operator</span><span class="p">(</span><span class="s2">"mul"</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="p">{</span><span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">},</span> <span class="n">output</span><span class="o">=</span><span class="n">O</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">O</span>

<span class="k">def</span> <span class="nf">operator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">):</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
    <span class="n">paddle</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span><span class="n">create_operator</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="p">{</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">},</span> <span class="n">output</span><span class="o">=</span><span class="n">O</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">O</span>
</pre></div>
</div>
<p>Above code snippets are automatically generated.  Given them, users can define</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>If we don’t have <code class="docutils literal"><span class="pre">operator.mul</span></code> and <code class="docutils literal"><span class="pre">operator.add</span></code>, the definiton of <code class="docutils literal"><span class="pre">layer.fc</span></code> would be complicated:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
    <span class="n">O1</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
    <span class="n">paddle</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span><span class="n">create_operator</span><span class="p">(</span><span class="s2">"mul"</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="n">O1</span><span class="p">)</span>
    <span class="n">O2</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
    <span class="n">paddle</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span><span class="n">create_operator</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="n">O1</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="n">O2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">O2</span>
</pre></div>
</div>
<p>We’d like to have Python bindings to operators in package <code class="docutils literal"><span class="pre">paddle.operator</span></code>, and Python compositions of operators in package <code class="docutils literal"><span class="pre">paddle.layer</span></code>.  So we have the following concepts in above illustrative example:</p>
<table>
<thead>
<tr>
<th>C++ functions/functors</th>
<th>mul</th>
<th>add</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>C++ operator class </td>
<td>mulOp</td>
<td>addOp </td>
<td>FCOp </td>
<td></td>
</tr>
<tr>
<td>Python binding  </td>
<td>operator.mul</td>
<td> operator.add </td>
<td>operator.fc </td>
<td></td>
</tr>
<tr>
<td>Python function   </td>
<td></td>
<td></td>
<td> </td>
<td>layer.fc</td>
</tr>
</tbody>
</table><p>This is how we differentiate layer and operators in PaddlePaddle:</p>
<ul class="simple">
<li>those defined in C++ and have a lightweighted Python wrapper in module <code class="docutils literal"><span class="pre">operators</span></code> are operators; whereas</li>
<li>those who don’t have C++ implementations but a Python implementation that compose C++ operators are known as layers.</li>
</ul>
</div>
</div>
<div class="articleComments">
</div>
</div>