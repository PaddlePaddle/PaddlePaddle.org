<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="channel-design">
<span id="channel-design"></span><h1>Channel Design<a class="headerlink" href="#channel-design" title="永久链接至标题">¶</a></h1>
<div class="section" id="introduction">
<span id="introduction"></span><h2>Introduction<a class="headerlink" href="#introduction" title="永久链接至标题">¶</a></h2>
<p>A Channel is a data structure that allows for synchronous interprocess
communication via message passing.  It is a fundemental component of CSP
(communicating sequential processes), and allows for users to pass data
between threads without having to worry about synchronization.</p>
</div>
<div class="section" id="how-to-use-it">
<span id="how-to-use-it"></span><h2>How to use it<a class="headerlink" href="#how-to-use-it" title="永久链接至标题">¶</a></h2>
<p>Paddle offers python APIs to open and close channels, along with sending
and receiving data to/from a channel.</p>
<div class="section" id="create-a-channel">
<span id="create-a-channel"></span><h3>Create a channel<a class="headerlink" href="#create-a-channel" title="永久链接至标题">¶</a></h3>
<p>Creates a new channel that takes in variables of a specific dtype.</p>
<ul class="simple">
<li><strong>fluid.make_channel(dtype, capacity=0)</strong><ul>
<li><strong>dtype</strong>: The data type of variables being sent/received through channel</li>
<li><strong>capacity</strong>: The capacity of the channel.  A capacity of 0 represents
an unbuffered channel.  Capacity &gt; 0 represents a buffered channel</li>
</ul>
</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ch</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">make_channel</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">LOD_TENSOR</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="close-a-channel">
<span id="close-a-channel"></span><h3>Close a channel<a class="headerlink" href="#close-a-channel" title="永久链接至标题">¶</a></h3>
<p>Closes a channel.  Any pending senders and receivers will be awoken during
this time.  Receivers can still receive from a closed channel, but senders
are not allowed to send any additional data to the channel (Paddle will
raise an exception if users try to send to a closed channel.)</p>
<ul class="simple">
<li><strong>fluid.channel_close(channel)</strong></li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">fluid</span><span class="o">.</span><span class="n">channel_close</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="send-data-to-a-channel">
<span id="send-data-to-a-channel"></span><h3>Send data to a channel<a class="headerlink" href="#send-data-to-a-channel" title="永久链接至标题">¶</a></h3>
<p>Sends a variable to a channel.  Currently, variables of dtype <code class="docutils literal"><span class="pre">LoDTensor</span></code>,
<code class="docutils literal"><span class="pre">LoDRankTable</span></code>, <code class="docutils literal"><span class="pre">LoDTensorArray</span></code>, <code class="docutils literal"><span class="pre">SelectedRows</span></code>, <code class="docutils literal"><span class="pre">ReaderHolder</span></code>, and
<code class="docutils literal"><span class="pre">ChannelHolder</span></code> are supported.</p>
<p>By default, the data of the Variable is moved from the sender to the receiver,
however the user can optionally copy the data before performing the send.</p>
<ul class="simple">
<li><strong>channel_send(channel, variable, is_copy=False)</strong><ul>
<li><strong>channel</strong>: The channel to send the variable to</li>
<li><strong>variable</strong>: The variable to send to the channel</li>
<li><strong>is_copy</strong>: If set to True, channel_send will perform a variable assign
to copy the source variable to a new variable to be sent.</li>
</ul>
</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ch</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">make_channel</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">LOD_TENSOR</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">fill_constant</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">INT32</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">fluid</span><span class="o">.</span><span class="n">channel_send</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="receive-data-from-a-channel">
<span id="receive-data-from-a-channel"></span><h3>Receive data from a channel<a class="headerlink" href="#receive-data-from-a-channel" title="永久链接至标题">¶</a></h3>
<p>Receives a variable from a channel.  The data of the variable is moved to the
receiving variable.</p>
<ul class="simple">
<li><strong>channel_recv(channel, return_variable)</strong><ul>
<li><strong>channel</strong>: The channel to receive the variable from</li>
<li><strong>return_variable</strong>: The destination variable used to store the data of the
variable received from the channel</li>
</ul>
</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ch</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">make_channel</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">LOD_TENSOR</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">fill_constant</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">VarDesc</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">INT32</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fluid</span><span class="o">.</span><span class="n">channel_recv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-it-works">
<span id="how-it-works"></span><h2>How it Works<a class="headerlink" href="#how-it-works" title="永久链接至标题">¶</a></h2>
<p>Channels provides a simple interface for different threads to share data.
To support the synchronization requirements, channels utilizes a series of
internal queues, locks, and conditional variables.</p>
<div class="section" id="queuemessage">
<span id="queuemessage"></span><h3>QueueMessage<a class="headerlink" href="#queuemessage" title="永久链接至标题">¶</a></h3>
<p>QueueMessage encapsulates the state of the channel send/receive operation to be
put in the <strong>sendq/recvq</strong>.  It contains a condition variable used to lock the
thread (when there are no available sends/receives).  In addition, it contains
a callback function to notify a thread when the QueueMessage is being
processed by the channel.</p>
</div>
<div class="section" id="queues">
<span id="queues"></span><h3>Queues<a class="headerlink" href="#queues" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li>**buff_**: This queue holds the data buffer in a buffered channel.  The
capacity is set to the capacity of the channel.  This data buffer is not
used in an unbuffered channel.</li>
<li><strong>sendq</strong>: This queue holds the QueueMessage of any pending senders of a
channel.  When a thread performs a channel_send operation on the channel, the
channel_send operation will put a new QueueMessage on the sendq and block the
current thread under two conditions:<ol>
<li>The channel is buffered and is full</li>
<li>The channel is unbuffered and does not have a receiver</li>
</ol>
</li>
<li><strong>recvq</strong>:  This queue holds the QueueMessage of any pending receivers of a
channel.  When a thread performs a channel_recv operation on the channel, the
channel_recv operation will put a new QueueMessage on the recvq and block the
current thread under two conditions:<ol>
<li>The channel is buffered and there is no data on the buff_</li>
<li>The channel is unbuffered and does not have a sender</li>
</ol>
</li>
</ul>
</div>
<div class="section" id="state-diagram">
<span id="state-diagram"></span><h3>State diagram<a class="headerlink" href="#state-diagram" title="永久链接至标题">¶</a></h3>
<div class="section" id="channel-send">
<span id="channel-send"></span><h4>Channel Send<a class="headerlink" href="#channel-send" title="永久链接至标题">¶</a></h4>
<p align="center">
<img src="https://raw.githubusercontent.com/PaddlePaddle/Paddle/develop/doc/fluid/images/channel_send.png"/><br/>
</p></div>
<div class="section" id="channel-receive">
<span id="channel-receive"></span><h4>Channel Receive<a class="headerlink" href="#channel-receive" title="永久链接至标题">¶</a></h4>
<p align="center">
<img src="https://raw.githubusercontent.com/PaddlePaddle/Paddle/develop/doc/fluid/images/channel_recv.png"/><br/>
</p></div>
</div>
</div>
<div class="section" id="limitations-and-considerations">
<span id="limitations-and-considerations"></span><h2>Limitations and Considerations<a class="headerlink" href="#limitations-and-considerations" title="永久链接至标题">¶</a></h2>
<div class="section" id="variable-copy">
<span id="variable-copy"></span><h3>Variable Copy<a class="headerlink" href="#variable-copy" title="永久链接至标题">¶</a></h3>
<p>In golang, variables in channels are copied from the sender to the receiver.
In Paddle, the data from our variables are <strong>moved</strong> from sender to receiver.
As a result, these variables should not be used after they are sent.  We
provide a flag in channel_send method to allow users to copy the variable to
be sent before it is sent.</p>
<p>Please note that this is acheived by adding an <strong>assign</strong> operator and creating
a temporary variable that is sent in place of the original variable.  Please
note that <strong>assign</strong> operator has limited support for only certain variables
datatypes.</p>
</div>
</div>
</div>
</div>
<div class="articleComments">
</div>
</div>