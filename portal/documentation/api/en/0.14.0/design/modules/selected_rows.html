<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="design-doc-selected-rows">
<span id="design-doc-selected-rows"></span><h1>Design Doc: Selected Rows<a class="headerlink" href="#design-doc-selected-rows" title="永久链接至标题">¶</a></h1>
<p><code class="docutils literal"><span class="pre">SelectedRows</span></code> is a type of sparse tensor data type, which is designed to support <code class="docutils literal"><span class="pre">embedding</span></code> operators. The gradient of embedding table is a sparse tensor. Only a few rows are non-zero values in this tensor. It is straight-forward to represent a sparse tensor by the following sparse tensor data structure:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SelectedRows</span> <span class="p">{</span>
 <span class="k">private</span><span class="o">:</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">rows_</span><span class="p">;</span>
  <span class="n">Tensor</span> <span class="n">value_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">height_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The field <code class="docutils literal"><span class="pre">height_</span></code> is the first dimension of <code class="docutils literal"><span class="pre">SelectedRows</span></code>. The <code class="docutils literal"><span class="pre">rows</span></code> are the indices of the non-zero rows of <code class="docutils literal"><span class="pre">SelectedRows</span></code>. The <code class="docutils literal"><span class="pre">value_</span></code> field is an N-dim tensor of shape <code class="docutils literal"><span class="pre">[rows.size()</span> <span class="pre">/*</span> <span class="pre">NUM_ROWS</span> <span class="pre">*/,</span> <span class="pre">...]</span></code>, which supplies values for each row. The dimension of <code class="docutils literal"><span class="pre">SelectedRows</span></code> satisfies <code class="docutils literal"><span class="pre">[height_]</span> <span class="pre">+</span> <span class="pre">value_.shape[1:]</span></code>.</p>
<p>Suppose that a SelectedRows-typed variable <code class="docutils literal"><span class="pre">x</span></code> has many rows, but only two of them have values – row 73 is <code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2]</span></code> and row 84 is <code class="docutils literal"><span class="pre">[3,</span> <span class="pre">4]</span></code>, the <code class="docutils literal"><span class="pre">SelectedRows</span></code> representation would be:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">SelectedRow</span> <span class="p">{</span>
  <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">73</span><span class="p">,</span> <span class="mi">84</span><span class="p">],</span>
  <span class="n">value</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="selectedrows-in-protobuf">
<span id="selectedrows-in-protobuf"></span><h2>SelectedRows in Protobuf<a class="headerlink" href="#selectedrows-in-protobuf" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">SelectedRows</span></code> is a type of <code class="docutils literal"><span class="pre">Variable</span></code>. <code class="docutils literal"><span class="pre">VarDesc</span></code> in protobuf should describe the <code class="docutils literal"><span class="pre">SelectedRows</span></code> information. Only the tensor dimension of a <code class="docutils literal"><span class="pre">SelectedRows</span></code> will be described in compile-time because the <code class="docutils literal"><span class="pre">rows_</span></code> and <code class="docutils literal"><span class="pre">value_</span></code> are dependent on the training data.
So we use <code class="docutils literal"><span class="pre">TensorDesc</span></code> to unify <code class="docutils literal"><span class="pre">data_type</span></code> and <code class="docutils literal"><span class="pre">dims</span></code>. A LodTensorDesc contains a <code class="docutils literal"><span class="pre">TensorDesc</span></code> and <code class="docutils literal"><span class="pre">lod_level</span></code>. The description of <code class="docutils literal"><span class="pre">SelectedRows</span></code> is a Tensor description.</p>
<div class="highlight-proto"><div class="highlight"><pre><span></span><span class="kd">message</span> <span class="nc">TensorDesc</span> <span class="p">{</span>
  <span class="k">required</span> <span class="n">DataType</span> <span class="na">data_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="kt">int64</span> <span class="na">dims</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// [UNK, 640, 480] is saved as [-1, 640, 480]</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">LodTensorDesc</span> <span class="p">{</span>
  <span class="k">required</span> <span class="n">TensorDesc</span> <span class="na">tensor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">optional</span> <span class="n">int</span> <span class="na">lod_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">VarDesc</span> <span class="p">{</span>
  <span class="k">required</span> <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">enum</span> <span class="n">VarType</span> <span class="p">{</span> 
    <span class="na">LOD_TENSOR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">SELECTED_ROWS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">required</span> <span class="n">VarType</span> <span class="na">type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">optional</span> <span class="n">LodTensorDesc</span> <span class="na">lod_desc</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="k">optional</span> <span class="n">TensorDesc</span> <span class="na">selected_rows_desc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">optional</span> <span class="kt">bool</span> <span class="na">persistable</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">[</span> <span class="k">default</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="infershape-for-selected-rows">
<span id="infershape-for-selected-rows"></span><h2>InferShape for Selected Rows<a class="headerlink" href="#infershape-for-selected-rows" title="永久链接至标题">¶</a></h2>
<p>Just like <code class="docutils literal"><span class="pre">LoD</span></code> information, <code class="docutils literal"><span class="pre">InferShape</span></code> method will infer the output tensor type as well. The operator should decide whether its output is a <code class="docutils literal"><span class="pre">SelectedRows</span></code> or <code class="docutils literal"><span class="pre">Dense</span></code> tensor.</p>
<p>For example, the gradient operator of <code class="docutils literal"><span class="pre">TableLookup</span></code> will always generate <code class="docutils literal"><span class="pre">SelectedRows</span></code>. Its <code class="docutils literal"><span class="pre">InferShape</span></code> method should be like following</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">TableLookupGrad</span><span class="o">::</span><span class="n">InferShape</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">context</span><span class="p">.</span><span class="n">SetDataType</span><span class="p">(</span><span class="s">"Embedding.Grad"</span><span class="p">,</span> <span class="n">kSelectedRows</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="sparse-operators">
<span id="sparse-operators"></span><h2>Sparse Operators<a class="headerlink" href="#sparse-operators" title="永久链接至标题">¶</a></h2>
<p>There are several operators that need to be written to support <code class="docutils literal"><span class="pre">SelectedRows</span></code>. These are:</p>
<ol class="simple">
<li>Operators which generate <code class="docutils literal"><span class="pre">SelectedRows</span></code> gradient. e.g. Gradient of <code class="docutils literal"><span class="pre">TableLookupOp</span></code>.</li>
<li>Optimize operators which support <code class="docutils literal"><span class="pre">SelectedRows</span></code> gradient. e.g. <code class="docutils literal"><span class="pre">SGD</span></code> or <code class="docutils literal"><span class="pre">AdaGrad</span></code> for <code class="docutils literal"><span class="pre">SelectedRows</span></code>. However, there should be only one <code class="docutils literal"><span class="pre">SGD</span></code> operator. <code class="docutils literal"><span class="pre">OpWithKernel::Run</span></code> should select a suitable kernel for both <code class="docutils literal"><span class="pre">dense</span></code> tensor or <code class="docutils literal"><span class="pre">SelectedRows</span></code>.</li>
</ol>
</div>
</div>
</div>
<div class="articleComments">
</div>
</div>