{% verbatim %}
<p>运行本目录下的程序示例需要使用PaddlePaddle v0.10.0 版本。如果您的PaddlePaddle安装版本低于此要求，请按照<a href="http://www.paddlepaddle.org/docs/develop/documentation/zh/build_and_install/pip_install_cn.html">安装文档</a>中的说明更新PaddlePaddle安装版本。</p>
<hr/>
<h1>Youtube DNN推荐模型</h1>
<p>以下是本例目录包含的文件以及对应说明:</p>
<div class="highlight"><pre><span></span>├── README.md               # 文档
├── README.cn.md            # 中文文档
├── data                    # 示例数据
│   ├── data.tar            # 示例数据
├── infer.py                # 预测脚本
├── network_conf.py         # 模型网络配置
├── reader.py               # data reader
├── train.py                # 训练脚本
└── utils.py                # 工具
└── data_processer.py       # 数据预处理脚本
└── user_vector.py          # 获取用户向量脚本
└── item_vector.py          # 获取视频向量脚本
├── infer_user.py           # 获取用户个性化脚本
</pre></div>
<h2>背景介绍[<a href="#参考文献">1</a>]</h2>
<p>Youtube是世界最大的视频网站之一，其推荐系统帮助10亿以上的用户，从海量视频中，发现个性化的内容。该推荐系统主要面临以下三个挑战:
- 规模: 许多现有的推荐算法证明在小数据量下运行良好，但不能满足YouTube这样庞大的用户群和内容库的场景，因此需要高度专业化的分布式学习算法和高效的线上服务。
- 新鲜度: YouTube内容库更新频率极高，每秒上传大量视频。系统应及时追踪新上传的视频和用户的实时行为，并且模型在推荐新/旧视频上有良好平衡能力。
- 噪音: 噪音来自于两方面，其一，用户历史行为稀疏，且有各种不可观测的外部因素，以及用户满意度不明确。其二，内容本身的数据是非结构化的。因此算法应更具有鲁棒性。</p>
<p>下图展示了整个推荐系统框图:
</p><p align="center">
<img height="300" hspace="10" src="images/recommendation_system.png" width="500"/> <br/>
Figure 1. 推荐系统框图（出自论文[1]）
</p>
<p>整个推荐系统有两部分组成: 召回(candidate generation/recall)和排序(ranking)。
- 召回模型: 输入用户的历史行为，从大规模的内容库中获得一个小集合(百级别)。召回出的视频与用户高度相关。一个用户是用其历史点击过的视频，搜索过的关键词，和人口统计相关的特征来表征。
- 排序模型: 采用更精细的特征计算得到排序分，对召回得到的候选集合中的视频进行排序。</p>
<p>本文主要详细介绍了召回模型的原理与使用。</p>
<h2>召回模型简介</h2>
<p>该推荐问题可以被建模成一个"超大规模多分类"问题。即在时刻<img alt="" src="https://www.zhihu.com/equation?tex=t"/>，为用户<img alt="" src="https://www.zhihu.com/equation?tex=U"/>(已知上下文信息<img alt="" src="https://www.zhihu.com/equation?tex=C"/>)在视频库<img alt="" src="https://www.zhihu.com/equation?tex=V"/>中预测出观看视频<img alt="" src="https://www.zhihu.com/equation?tex=i"/>的类别，</p>
<p><img alt="" src="https://www.zhihu.com/equation?tex=%24P(%5Comega_t%3Di%7CU%2CC"/>%3D%5Cfrac%7Be%5E%7B%5Cmathbf%7Bv_i%7D%5Cmathbf%7Bu%7D%7D%7D%7B%5Csum_%7Bj%5Cin%20V%7D%5E%7B%20%7De%5E%7B%5Cmathbf%7Bv_j%7D%5Cmathbf%7Bu%7D%7D%7D)</p>
<p>其中<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D%5Cin%20%5Cmathbb%7BR%7D%5EN"/>，是&lt;用户，上下文信息&gt;的高维向量表示。<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bv_j%7D%5Cin%20%5Cmathbb%7BR%7D%5EN"/>是视频<img alt="" src="https://www.zhihu.com/equation?tex=j"/>的高维向量表示。DNN模型的目标是以用户信息和上下文信息为输入条件下，学习用户的高维向量表示，以此输入softmax分类器，来预测视频库中各个视频(类别)的观看概率。</p>
<p>下图展示了召回模型的网络结构:
</p><p align="center">
<img height="500" hspace="10" src="images/model_network.png" width="600"/> <br/>
Figure 2. 召回模型网络结构（出自论文[1]）
</p>
<ul>
<li>输入层:用户的浏览序列、搜索序列、人口统计学特征、和其他上下文信息等</li>
<li>embedding层:将用户浏览视频序列接embedding层，再做时间序列上的平均。对于搜索序列同样处理。</li>
<li>隐层:包含三个隐层，用RELU激活函数，最后一层隐层的输出即为高维向量表示<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D"/>。</li>
<li>输出层: softmax层，输出视频库中各个视频(类别)的观看概率。在线上预测时，提取模型训练得到的softmax层内部的参数，作为视频<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bv%7D"/>的高维向量表示。可利用类似局部敏感哈希(Locality Sensitive Hashing)用<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D"/>查询最相关的N个视频。</li>
</ul>
<h2>数据预处理</h2>
<p>本例模拟了用户的视频点击日志，作为样本数据。格式如下:
</p><div class="highlight"><pre><span></span>用户Id \t 所在省份 \t 所在城市 \t 历史点击的视频序列信息 \t 手机型号
历史点击的视频序列信息的格式为 视频信息1;视频信息2;...;视频信息K
视频信息的格式为 视频id:视频类目:视频标签1_视频标签2_视频标签3_...视频标签M
例如:
USER_ID_15  上海市  上海市    VIDEO_42:CATEGORY_9:TAG115;VIDEO_43:CATEGORY_9:TAG116_TAG115;VIDEO_44:CATEGORY_2:TAG117_TAG71  GO T5
</pre></div>
在youtube_recall目录下运行以下命令（下同），可以解压样本数据。
<div class="highlight"><pre><span></span>cd data
tar -zxvf data.tar
</pre></div>
<p>然后，脚本<code>data_preprocess.py</code>将对训练数据做预处理。具体使用方法参考如下说明：
</p><div class="highlight"><pre><span></span>usage: data_processor.py [-h] --train_set_path TRAIN_SET_PATH --output_dir
                         OUTPUT_DIR [--feat_appear_limit FEAT_APPEAR_LIMIT]

PaddlePaddle Youtube Recall Model Example

optional arguments:
  -h， --help            show this help message and exit
  --train_set_path TRAIN_SET_PATH
                        path of the train set
  --output_dir OUTPUT_DIR
                        directory to output
  --feat_appear_limit FEAT_APPEAR_LIMIT
                        the minimum number of feature values appears (default:
                        20)
</pre></div>
该脚本的作用如下:
- 借鉴[<a href="#参考文献">2</a>]中对特征的处理，过滤低频特征(样本中出现次数低于<code>feat_appear_limit</code>)。
- 对特征进行编码，生成字典<code>feature_dict.pkl</code>。
- 统计每个视频出现的概率，保存至<code>item_freq.pkl</code>，提供给nce层使用。
<p>例如可执行下列命令，完成数据预处理:
</p><div class="highlight"><pre><span></span>mkdir output
python data_processor.py --train_set_path<span class="o">=</span>./data/train.txt <span class="se">\</span>
                                     --output_dir<span class="o">=</span>./output <span class="se">\</span>
                                     --feat_appear_limit<span class="o">=</span><span class="m">20</span>
</pre></div>
<h2>模型实现</h2>
<p>下面是网络中各个部分的具体实现，相关代码均包含在 <code>./network_conf.py</code> 中。</p>
<h3>输入层</h3>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_build_input_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    build input layer</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_items</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"history_clicked_items"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value_sequence</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'history_clicked_items'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_categories</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"history_clicked_categories"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value_sequence</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'history_clicked_categories'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_tags</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"history_clicked_tags"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value_sequence</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'history_clicked_tags'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"user_id"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_province</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"province"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'province'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_city</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"city"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'city'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_phone</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"phone"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'phone'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_target_item</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"target_item"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'history_clicked_items'</span><span class="p">])))</span>
</pre></div>
<h3>Embedding层</h3>
<p>每个输入特征通过embedding到固定维度的向量中。
</p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_create_emb_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    create embedding parameter</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">paddle</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">initial_std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">l2_rate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sparse_update</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_build_embedding_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    build embedding layer</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_user_id_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">,</span>
                                               <span class="n">size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                                               <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span>
                                                   <span class="s1">'_proj_user_id'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_province_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_province</span><span class="p">,</span>
                                                <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                                <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span>
                                                    <span class="s1">'_proj_province'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_city_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_city</span><span class="p">,</span>
                                            <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                                            <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span><span class="s1">'_proj_city'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_phone_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phone</span><span class="p">,</span>
                                             <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                                             <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span><span class="s1">'_proj_phone'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_items_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_items</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span><span class="s1">'_proj_history_clicked_items'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_categories_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_categories</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span><span class="s1">'_proj_history_clicked_categories'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_tags_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_tags</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span><span class="s1">'_proj_history_clicked_tags'</span><span class="p">))</span>
</pre></div>
<h3>隐层</h3>
<p>本文对[<a href="#参考文献">原论文</a>](Covington, Paul, Jay Adams, and Emre Sargin. "Deep neural networks for youtube recommendations." Proceedings of the 10th ACM Conference on Recommender Systems. ACM, 2016.)中的模型做了如下改进：
- 历史用户点击的视频序列，经过embedding之后，不再使用加权求平均，而是使用lstm序列模型。本文将用户点击的先后次序纳入模型中，然后在时间序列上做最大池化，得到定长向量表示，从而使模型学习到与点击时序相关的隐藏信息。
- 考虑到数据规模与训练性能，本文只用了两个Relu层，也有很不错的效果。</p>
<div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">_rnn_cell</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">simple_lstm</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_items_emb</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lstm_last</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">pooling</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rnn_cell</span><span class="p">,</span> <span class="n">pooling_type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">pooling</span><span class="o">.</span><span class="n">Max</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_avg_emb_cats</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">pooling</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_categories_emb</span><span class="p">,</span>
            <span class="n">pooling_type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">pooling</span><span class="o">.</span><span class="n">Avg</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_avg_emb_tags</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">pooling</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_tags_emb</span><span class="p">,</span>
            <span class="n">pooling_type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">pooling</span><span class="o">.</span><span class="n">Avg</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fc_0</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"Relu1"</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lstm_last</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id_emb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_province_emb</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_city_emb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_emb_cats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_emb_tags</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_phone_emb</span>
            <span class="p">],</span>
            <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dnn_layer_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">act</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">activation</span><span class="o">.</span><span class="n">Relu</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fc_1</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"Relu2"</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fc_0</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dnn_layer_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">act</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">activation</span><span class="o">.</span><span class="n">Relu</span><span class="p">())</span>
</pre></div>
<h3>输出层</h3>
<p>为了提高模型训练速度，使用噪声对比估计（Noise-contrastive estimation， NCE）[<a href="#参考文献">3</a>]。将<a href="#数据预处理">数据预处理</a>中产出的item_freq.pkl，也就是负样例的分布，作为nce层的参数。
</p><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">nce</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fc_1</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_item</span><span class="p">,</span>
                <span class="n">num_classes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'history_clicked_items'</span><span class="p">]),</span>
                <span class="n">param_attr</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"nce_w"</span><span class="p">),</span>
                <span class="n">bias_attr</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"nce_b"</span><span class="p">),</span>
                <span class="n">act</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">activation</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">(),</span>
                <span class="n">num_neg_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">neg_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_item_freq</span><span class="p">)</span>
</pre></div>
<h2>训练</h2>
<p>首先，准备<code>reader.py</code>，负责将输入原始数据中的特征，转为编码后的特征id。对一条训练数据，根据<code>window_size</code>产出多条训练样本给trainer，例如:
</p><div class="highlight"><pre><span></span>window_size=2
原始数据:
用户Id \t 所在省份 \t 所在城市 \t 视频信息1;视频信息2;...;视频信息K \t 手机型号
多条训练样本:
用户Id，所在省份，所在城市，[&lt;unk&gt;，历史点击视频1]，[&lt;unk&gt;，历史点击视频类目1]，[&lt;unk&gt;，历史点击视频标签1]，手机型号，历史点击视频2
用户Id，所在省份，所在城市，[历史点击视频1，历史点击视频2]，[历史点击视频类目1，历史点击视频类目2]，[历史点击视频标签1，历史点击视频标签2]，手机型号，历史点击视频3
用户Id，所在省份，所在城市，[历史点击视频2，历史点击视频3]，[历史点击视频类目2，历史点击视频类目3]，[历史点击视频标签2，历史点击视频标签3]，手机型号，历史点击视频4
......
</pre></div>
相关代码如下:
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">history_clicked_items_all</span><span class="p">)):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window_size</span><span class="p">)</span>
    <span class="n">history_clicked_items</span> <span class="o">=</span> <span class="n">history_clicked_items_all</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">history_clicked_categories</span> <span class="o">=</span> <span class="n">history_clicked_categories_all</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">history_clicked_tags_str</span> <span class="o">=</span> <span class="n">history_clicked_tags_all</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">history_clicked_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tags_a</span> <span class="ow">in</span> <span class="n">history_clicked_tags_str</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags_a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_"</span><span class="p">):</span>
            <span class="n">history_clicked_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
    <span class="n">target_item</span> <span class="o">=</span> <span class="n">history_clicked_items_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">province</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> \
          <span class="n">history_clicked_items</span><span class="p">,</span> <span class="n">history_clicked_categories</span><span class="p">,</span> \
          <span class="n">history_clicked_tags</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">target_item</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="n">feature_dict</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
        <span class="n">paddle</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span>
            <span class="n">paddle</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">reader</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">train_set_path</span><span class="p">),</span>
                <span class="n">buf_size</span><span class="o">=</span><span class="mi">7000</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">),</span>
        <span class="n">num_passes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_passes</span><span class="p">,</span>
        <span class="n">feeding</span><span class="o">=</span><span class="n">feeding</span><span class="p">,</span>
        <span class="n">event_handler</span><span class="o">=</span><span class="n">event_handler</span><span class="p">)</span>
</pre></div>
接下去就可以开始训练了，可执行以下命令:
<div class="highlight"><pre><span></span>mkdir output/model
python train.py --train_set_path<span class="o">=</span><span class="s1">'./data/train.txt'</span> <span class="se">\</span>
    --test_set_path<span class="o">=</span><span class="s1">'./data/test.txt'</span> <span class="se">\</span>
    --model_output_dir<span class="o">=</span><span class="s1">'./output/model/'</span> <span class="se">\</span>
    --feature_dict<span class="o">=</span><span class="s1">'./output/feature_dict.pkl'</span> <span class="se">\</span>
    --item_freq<span class="o">=</span><span class="s1">'./output/item_freq.pkl'</span>
</pre></div>
<h2>离线预测</h2>
<p>输入用户相关的特征，输出topN个最可能观看的视频，可执行以下命令:
</p><div class="highlight"><pre><span></span>python infer.py --infer_set_path<span class="o">=</span><span class="s1">'./data/infer.txt'</span> <span class="se">\</span>
    --model_path<span class="o">=</span><span class="s1">'./output/model/model_pass_00000.tar.gz'</span> <span class="se">\</span>
    --feature_dict<span class="o">=</span><span class="s1">'./output/feature_dict.pkl'</span> <span class="se">\</span>
    --batch_size<span class="o">=</span><span class="m">50</span>
</pre></div>
<h2>在线预测</h2>
<p>在线预测的时候，采用近似最近邻（approximate nearest neighbor-ANN）算法直接用用户向量查询最相关的topN个视频向量，将对应的视频内容推荐给用户。下面介绍如何获得用户向量和视频向量。</p>
<h3>用户向量</h3>
<p>用最后一个RELU层的输出，前拼一个常数项1，作为用户向量。这边最后一个RELU层的大小是31维，拼接后的用户向量就是32维，即</p>
<p><img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D%3D%5B1%2Cu_1%2Cu_2%2C...%2Cu_%7B31%7D%5D"/></p>
<h3>视频向量</h3>
<p>视频向量从模型训练得到的softmax层的参数中提取。假设共有M个不同的视频，那么softmax层输出的是这M个视频各自用户点击的概率，即</p>
<p><img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bo%7D%3D%5Bs_1%2Cs_2%2C...%2Cs_%7BM%7D%5D"/></p>
<p>从最后一个RELU层输出的用户向量<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D"/>，到softmax层输出的M个视频的概率<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bo%7D"/>，中间则是通过乘以了softmax层的参数w,b构成的一个<img alt="" src="https://www.zhihu.com/equation?tex=32%5Ctimes%20M"/>矩阵，其中的每一列为一个32维的视频向量，按照字典顺序一一对应。</p>
<p><img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D%5Ccdot%20%5Cbegin%7Bbmatrix%7D%0A%20b_1%20%20%26%20b_2%20%26%20%20%5Ccdots%20%26%20b_M%20%5C%5C%20%0A%20w_%7B11%7D%20%26%20w_%7B21%7D%20%26%20%20%5Ccdots%20%20%26%20w_%7BM1%7D%20%5C%5C%20%0A%20w_%7B12%7D%20%26%20w_%7B22%7D%20%26%20%20%20%5Ccdots%20%26%20w_%7BM2%7D%20%20%5C%5C%20%0A%5Cvdots%20%26%20%5Cvdots%20%26%20%20%5Cvdots%20%26%20%5Cvdots%20%5C%5C%20%0Aw_%7B131%7D%20%26%20%20w_%7B231%7D%20%26%20%20%5Ccdots%20%20%26%20w_%7BM31%7D%20%20%0A%5Cend%7Bbmatrix%7D_%7B32%5Ctimes%20M%7D%20%3D%20%5Cmathbf%7Bu%7D%20%5Ccdot%20%20%5Cbegin%7Bbmatrix%7D%20%0A%5Cmathbf%7Bv_1%7D%2C%20%5Cmathbf%7Bv_2%7D%2C%20%5Ccdots%2C%20%5Cmathbf%7Bv_M%7D%20%0A%5Cend%7Bbmatrix%7D_%7B1%5Ctimes%20M%7D%3D%5Cmathbf%7Bo%7D"/></p>
<h3>SIMPLE-LSH变换</h3>
<p>很多ann算法只支持cosine距离，而模型是根据内积排序的，两者效果差异较大。为此，这边的解决方案是，对前面得到的用户和视频向量，作SIMPLE-LSH变换[<a href="#参考文献">4</a>]，使内积排序与cosin排序等价。</p>
<p>具体如下：
- 对于视频向量<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bv%7D%5Cin%20%5Cmathbb%7BR%7D%5EN"/>，有<img alt="" src="https://www.zhihu.com/equation?tex=%5Cleft%20%5C%7C%20%5Cmathbf%7Bv%7D%20%5Cright%20%5C%7C%5Cleqslant%20m"/>，变换后的<img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bv%7D%7D%5Cin%20%5Cmathbb%7BR%7D%5E%7BN%2B1%7D"/>，<img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bv%7D%7D%20%3D%20%5B%5Cfrac%7B%5Cmathbf%7Bv%7D%7D%7Bm%7D%3B%20%5Csqrt%7B1%20-%5Cleft%20%5C%7C%20%5Cmathbf%7B%5Cfrac%7B%5Cmathbf%7Bv%7D%7D%7Bm%7D%7B%7D%7D%20%5Cright%20%5C%7C%5E2%7D%5D"/>。</p>
<ul>
<li>对于用户向量<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D%5Cin%20%5Cmathbb%7BR%7D%5EN"/>，变换后的<img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%5Cin%20%5Cmathbb%7BR%7D%5E%7BN%2B1%7D"/>，<img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%20%3D%20%5B%5Cmathbf%7Bu%7D_%7Bnorm%7D%3B%200%5D"/>，其中<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D_%7Bnorm%7D"/>是模长归一化后的<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D"/>。</li>
</ul>
<p>线上对于一个<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D"/>用内积召回<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bv%7D"/>，作上述变换<img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D%5Crightarrow%20%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%2C%20%5Cmathbf%7Bv%7D%5Crightarrow%20%5Ctilde%7B%5Cmathbf%7Bv%7D%7D"/>后，不改变内积排序的顺序。又因为<img alt="" src="https://www.zhihu.com/equation?tex=%5Cleft%20%5C%7C%20%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%20%5Cright%20%5C%7C"/> 和<img alt="" src="https://www.zhihu.com/equation?tex=%5Cleft%20%5C%7C%20%5Ctilde%7B%5Cmathbf%7Bv%7D%7D%20%5Cright%20%5C%7C"/>都为1，因此<img alt="" src="https://www.zhihu.com/equation?tex=cos(%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%20%2C%5Ctilde%7B%5Cmathbf%7Bv%7D%7D"/>%20%3D%20%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%5Ccdot%20%5Ctilde%7B%5Cmathbf%7Bv%7D%7D)，就可以兼容ANN用cosin的方式召回了，结果等价。</p>
<p>线上使用时，为保留精度，可以不除以<img alt="" src="https://www.zhihu.com/equation?tex=m"/>，也就变成<img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bv%7D%7D%3D%5B%5Cmathbf%7Bv%7D%3B%5Csqrt%7Bm%5E2-%5Cleft%5C%7C%20%5Cmathbf%7B%5Cmathbf%7Bv%7D%7D%5Cright%5C%7C%5E2%7D%5D"/>，排序依然等价。</p>
<h3>实现</h3>
<p>可使用<code>user_vector.py</code>获取用户向量， 输入用户特征经过网络预测，probs[1]中存储的是最后一个RELU层的输出，先前拼接一个1，再做SIMPLE-LSH变换（后接一个0，归一化）：
</p><div class="highlight"><pre><span></span><span class="n">probs</span> <span class="o">=</span> <span class="n">inferer</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">test_batch</span><span class="p">,</span>
        <span class="n">feeding</span><span class="o">=</span><span class="n">feeding</span><span class="p">,</span>
        <span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s2">"value"</span><span class="p">],</span>
        <span class="n">flatten_result</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">probs</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
    <span class="c1"># do simple lsh conversion</span>
    <span class="n">user_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.000</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">user_vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">user_vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.000</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">user_vector</span><span class="p">)</span>
    <span class="n">user_vector_norm</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span> <span class="o">/</span> <span class="n">norm</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">user_vector</span><span class="p">]</span>
    <span class="k">print</span> <span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_vector_norm</span><span class="p">)</span>
</pre></div>
<p>可使用<code>item_vector.py</code>分别获视频向量。加载模型，提取参数nce_w和nce_b，拼接M个视频向量，第i个视频向量的第一维是对应的nce_b[0][i]，后面是nce_w[i][1:31]。再做SIMPLE-LSH变换，找到所有向量最大的模，按照<img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bv%7D%7D%3D%5B%5Cmathbf%7Bv%7D%3B%5Csqrt%7Bm%5E2-%5Cleft%5C%7C%20%5Cmathbf%7B%5Cmathbf%7Bv%7D%7D%5Cright%5C%7C%5E2%7D%5D"/>处理。
</p><div class="highlight"><pre><span></span><span class="c1"># load the trained model.</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">Parameters</span><span class="o">.</span><span class="n">from_tar</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">nce_w</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"nce_w"</span><span class="p">)</span>
    <span class="n">nce_b</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"nce_b"</span><span class="p">)</span>
    <span class="n">item_vector</span> <span class="o">=</span> <span class="n">convt_simple_lsh</span><span class="p">(</span><span class="n">get_item_vec_from_softmax</span><span class="p">(</span><span class="n">nce_w</span><span class="p">,</span> <span class="n">nce_b</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_item_vec_from_softmax</span><span class="p">(</span><span class="n">nce_w</span><span class="p">,</span> <span class="n">nce_b</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    get item vectors from softmax parameter</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">nce_w</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">nce_b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_items_num</span> <span class="o">=</span> <span class="n">nce_w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">total_items_num</span> <span class="o">!=</span> <span class="n">nce_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">dim_vector</span> <span class="o">=</span> <span class="n">nce_w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_items_num</span><span class="p">):</span>
        <span class="n">vector</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nce_b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim_vector</span><span class="p">):</span>
            <span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nce_w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">vector</span>


<span class="k">def</span> <span class="nf">convt_simple_lsh</span><span class="p">(</span><span class="n">vector</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    do simple lsh conversion</span>
<span class="sd">    """</span>
    <span class="n">max_norm</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_of_vec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_of_vec</span><span class="p">):</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="o">&gt;</span> <span class="n">max_norm</span><span class="p">:</span>
            <span class="n">max_norm</span> <span class="o">=</span> <span class="n">norm</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_of_vec</span><span class="p">):</span>
        <span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">max_norm</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">vector</span>
</pre></div>
<p>可执行下列命令运行脚本：
</p><div class="highlight"><pre><span></span>python user_vector.py --infer_set_path<span class="o">=</span><span class="s1">'./data/infer.txt'</span> <span class="se">\</span>
        --model_path<span class="o">=</span><span class="s1">'./output/model/model_pass_00000.tar.gz'</span> <span class="se">\</span>
            --feature_dict<span class="o">=</span><span class="s1">'./output/feature_dict.pkl'</span> <span class="se">\</span>
                --batch_size<span class="o">=</span><span class="m">50</span>
python item_vector.py --model_path<span class="o">=</span><span class="s1">'./output/model/model_pass_00000.tar.gz'</span> <span class="se">\</span>
            --feature_dict<span class="o">=</span><span class="s1">'./output/feature_dict.pkl'</span>
</pre></div>
<h2>离线挖掘</h2>
<p>因为实时召回需要大量机器资源，这边也可以离线挖掘产出数据，线上召回使用挖掘好的数据。可以产出最热，用户个性化，视频相关等数据。下面的示例产出了用户个性化数据。
</p><div class="highlight"><pre><span></span>python infer_user.py --model_path='./output/model/model_pass_00000.tar.gz' \
            --feature_dict='./output/feature_dict.pkl'
</pre></div>
<h2>参考文献</h2>
<ol>
<li>Covington, Paul, Jay Adams, and Emre Sargin. "Deep neural networks for youtube recommendations." Proceedings of the 10th ACM Conference on Recommender Systems. ACM, 2016.</li>
<li>https://code.google.com/archive/p/word2vec/</li>
<li>http://paddlepaddle.org/docs/develop/models/nce_cost/README.html</li>
<li>Neyshabur, Behnam, and Nathan Srebro. "On symmetric and asymmetric LSHs for inner product search." arXiv preprint arXiv:1410.5518 (2014).</li>
</ol>
{% endverbatim %}