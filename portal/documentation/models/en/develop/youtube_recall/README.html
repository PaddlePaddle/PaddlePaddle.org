{% verbatim %}
<p>The minimum PaddlePaddle version needed for the code sample in this directory is v0.10.0. If you are on a version of PaddlePaddle earlier than v0.10.0, <a href="http://www.paddlepaddle.org/docs/develop/documentation/en/build_and_install/pip_install_en.html">please update your installation</a>.</p>
<hr/>
<h1>Deep Neural Networks for YouTube Recommendations</h1>
<h2>Introduction[<a href="#References">1</a>]</h2>
<p>YouTube is the world's largest platform for creating, sharing and discovering video content. Youtube recommendations are responsible for helping more than a billion users discover personalized content from an ever-growing corpus of videos.
- Scale: Many existing recommendation algorithm proven to work well on small problems fail to operate on massive scale. Highly specialized distributed learning algorithms and efficient serving systems are essential.
- Freshness: YouTube has a very dynamic corpus with many hours of video are uploaded per second. The recommendation system should model newly uploaded content as well as the latest actions taken by user.
- Noise: Historical user behavior on YouTube is inherently difficult to predict due to sparsity and a variety of unobservable external factors. Furthermore, the noisy implicit feedback signals instead of the ground truth of user satisfaction is observed, and metadata associated with content is poorly structured, which forces the algorithms to be robust.</p>
<p>The overall structure of the recommendation system is illustrated in Figure 1.
</p><p align="center">
<img height="300" hspace="10" src="images/recommendation_system.png" width="500"/> <br/>
Figure 1. Recommendation system architecture[1]
</p>
<p>The system is comprised of two neural networks: one for candidate generation and one for ranking.
- The candidate generation network: It takes events from the user's YouTube activity history as input and retrieves a small subset(hundreds) of videos, highly relevant to the user, from a large corpus. The similarity between users is expressed in terms of coarse features such as IDs of video watches, search query tokens and demographics.
- The ranking network: It accomplishes this task by assigning a score to each video according to a desired objective function using a rich set of features describing the video and user.</p>
<p>This markdown describes the principle and use of the candidate generation network in detail.</p>
<h2>Candidate Generation</h2>
<p>Here, candidate generation is modeled as extreme multiclass classification where the prediction problem becomes accurately classifying a specific video watch <img alt="" src="https://www.zhihu.com/equation?tex=%5Comega_t"/> at time <img alt="" src="https://www.zhihu.com/equation?tex=t"/> among millions of video <img alt="" src="https://www.zhihu.com/equation?tex=i"/> (classes) from a corpus <img alt="" src="https://www.zhihu.com/equation?tex=V"/> based on user <img alt="" src="https://www.zhihu.com/equation?tex=U"/> and context <img alt="" src="https://www.zhihu.com/equation?tex=C"/>,</p>
<p><img alt="" src="https://www.zhihu.com/equation?tex=%24P(%5Comega_t%3Di%7CU%2CC"/>%3D%5Cfrac%7Be%5E%7B%5Cmathbf%7Bv_i%7D%5Cmathbf%7Bu%7D%7D%7D%7B%5Csum_%7Bj%5Cin%20V%7D%5E%7B%20%7De%5E%7B%5Cmathbf%7Bv_j%7D%5Cmathbf%7Bu%7D%7D%7D)</p>
<p>where <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D%5Cin%20%5Cmathbb%7BR%7D%5EN"/> represents a high-dimensional "embedding" of the user, context pair and the <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bv_j%7D%5Cin%20%5Cmathbb%7BR%7D%5EN"/> represent embeddings of each candidate video. The task of the deep neural network is to learn user embeddings <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D"/> as a function of the user's history and context that are useful for discriminating among videos with a softmax classifier.</p>
<p>Figure 2 shows the general network architecture of candidate generation model:
</p><p align="center">
<img height="500" hspace="10" src="images/model_network.png" width="600"/> <br/>
Figure 2. Candidate generation model architecture[1]
</p>
<ul>
<li>Input layer: A user's watch history is represented by a variable-length sequence of sparse video IDs, and search history is similarly represented by a variable-length sequence of search tokens.</li>
<li>Embedding layer: The input features each is mapped to a fixed-sized dense vector representation via the embeddings, and then simply averaging the embeddings. The embeddings are learned jointly with all other model parameters through normal gradient descent back-propagation updates.</li>
<li>Hidden layer: Features are concatenated into a wide first layer, followed by several layers of fully connected Rectified Linear Units (ReLU). The output of the last ReLU layer is the previous mentioned high-dimensional "embedding" of the user <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D"/>, so called user vector.</li>
<li>Output layer: A softmax classifier is connected to do discriminating millions of classes (videos). To speed up training process, a technique is applied that samples negative classes from background distribution with importance weighting. The previous mentioned high-dimensional "embedding" of the candidate video <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bv%7D"/> is obtained by weight and bias of the softmax layer. At serving time, the most likely N classes (videos) is computed for presenting to the user. To Score millions of items under a strict serving laterncy, the scoring problem reduces to a nearest neighbor search in the dot product space, and Locality Sensitive Hashing is relied on.</li>
</ul>
<h2>Data Pre-processing</h2>
<p>In this example, here moke the click log of users as sample data, and its format is as follows:
</p><div class="highlight"><pre><span></span>user-id \t province \t city \t history-clicked-video-info-sequence \t phone

history-clicked-video-info-sequence is formated as
video-info1;video-info2;...;video-infoK

video-info is formated as
video-id:category:tag1_tag2_tag3_...tagM

For example:
USER_ID_15  Shanghai  Shanghai    VIDEO_42:CATEGORY_9:TAG115;VIDEO_43:CATEGORY_9:TAG116_TAG115;VIDEO_44:CATEGORY_2:TAG117_TAG71  GO T5
</pre></div>
Run this code in <code>youtube_recall</code> directory (the same below) to prepare the sample data.
<div class="highlight"><pre><span></span>cd data
tar -zxvf data.tar
</pre></div>
<p>Then, run <code>data_preprocess.py</code> for data pre-processiong. Refer to the following instructionsï¼š
</p><div class="highlight"><pre><span></span>usage: data_processor.py [-h] --train_set_path TRAIN_SET_PATH --output_dir
                         OUTPUT_DIR [--feat_appear_limit FEAT_APPEAR_LIMIT]

PaddlePaddle Deep Candidate Generation Example

optional arguments:
  -h, --help            show this help message and exit
  --train_set_path TRAIN_SET_PATH
                        path of the train set
  --output_dir OUTPUT_DIR
                        directory to output
  --feat_appear_limit FEAT_APPEAR_LIMIT
                        the minimum number of feature values appears (default:
                        20)
</pre></div>
The fucntion of this script is as follows:
- Filter low-frequency features[<a href="#References">2</a>], which appears less than <code>feat_appear_limit</code> times.
- Encode features, and generate dictionary <code>feature_dict.pkl</code>.
- Count the probability of each video appears and write into <code>item_freq.pkl</code>, and provide it to NCE layer.
<p>For example, run the following command to accomplish data pre-processing:
</p><div class="highlight"><pre><span></span>mkdir output
python data_processor.py --train_set_path=./data/train.txt \
                                     --output_dir=./output \
                                     --feat_appear_limit=20
</pre></div>
<h2>Model Implementaion</h2>
<p>The details of model implementation is illustrated as follows. The code is in <code>./network_conf.py</code>.</p>
<h3>Input layer</h3>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_build_input_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    build input layer</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_items</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"history_clicked_items"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value_sequence</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'history_clicked_items'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_categories</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"history_clicked_categories"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value_sequence</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'history_clicked_categories'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_tags</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"history_clicked_tags"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value_sequence</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'history_clicked_tags'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"user_id"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_province</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"province"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'province'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_city</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"city"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'city'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_phone</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"phone"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'phone'</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_target_item</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"target_item"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'history_clicked_items'</span><span class="p">])))</span>
</pre></div>
<h3>Embedding layer</h3>
<p>The each of input features is mapped to a fixed-sized dense vector representation
</p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_create_emb_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    create embedding parameter</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">paddle</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">initial_std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">l2_rate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sparse_update</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_build_embedding_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    build embedding layer</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_user_id_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">,</span>
                                               <span class="n">size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                                               <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span>
                                                   <span class="s1">'_proj_user_id'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_province_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_province</span><span class="p">,</span>
                                                <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                                <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span>
                                                    <span class="s1">'_proj_province'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_city_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_city</span><span class="p">,</span>
                                            <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                                            <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span><span class="s1">'_proj_city'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_phone_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phone</span><span class="p">,</span>
                                             <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                                             <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span><span class="s1">'_proj_phone'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_items_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_items</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span><span class="s1">'_proj_history_clicked_items'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_categories_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_categories</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span><span class="s1">'_proj_history_clicked_categories'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_tags_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_tags</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="n">param_attr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_emb_attr</span><span class="p">(</span><span class="s1">'_proj_history_clicked_tags'</span><span class="p">))</span>
</pre></div>
<h3>Hiddern layer</h3>
<p>Here improves the original networks in [<a href="#References">Original Paper</a>](Covington, Paul, Jay Adams, and Emre Sargin. "Deep neural networks for youtube recommendations." Proceedings of the 10th ACM Conference on Recommender Systems. ACM, 2016.)
- By modifying that the embeddings of video watches are not simply averaged but are connected to a LSTM layer with max temporal pooling instead, so that the deep sequential information related to user interests can be learned well.
- Considering data scale and efficiency of training, only two ReLU layers are applied, which also leads to good performance.</p>
<div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">_rnn_cell</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">simple_lstm</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_items_emb</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_lstm_last</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">pooling</span><span class="p">(</span>
    <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rnn_cell</span><span class="p">,</span> <span class="n">pooling_type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">pooling</span><span class="o">.</span><span class="n">Max</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_avg_emb_cats</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">pooling</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_categories_emb</span><span class="p">,</span>
                                          <span class="n">pooling_type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">pooling</span><span class="o">.</span><span class="n">Avg</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_avg_emb_tags</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">pooling</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history_clicked_tags_emb</span><span class="p">,</span>
                                          <span class="n">pooling_type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">pooling</span><span class="o">.</span><span class="n">Avg</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_fc_0</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Relu1"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_lstm_last</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id_emb</span><span class="p">,</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">_city_emb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phone_emb</span><span class="p">],</span>
    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dnn_layer_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">act</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">activation</span><span class="o">.</span><span class="n">Relu</span><span class="p">())</span>

<span class="bp">self</span><span class="o">.</span><span class="n">_fc_1</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Relu2"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fc_0</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dnn_layer_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">act</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">activation</span><span class="o">.</span><span class="n">Relu</span><span class="p">())</span>
</pre></div>
<h3>Output layer</h3>
<p>To speed up training process, Noise-contrastive estimation, NCE[<a href="#references">3</a>] is applied to sample negative classes from background distribution with importance weighting. The previous mentioned <code>item_freq.pkl</code><a href="#data pre-processing">data pre-processing</a> is used as neg_distribution.
</p><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">nce</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fc_1</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_item</span><span class="p">,</span>
                <span class="n">num_classes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_dict</span><span class="p">[</span><span class="s1">'history_clicked_items'</span><span class="p">]),</span>
                <span class="n">param_attr</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"nce_w"</span><span class="p">),</span>
                <span class="n">bias_attr</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"nce_b"</span><span class="p">),</span>
                <span class="n">num_neg_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">neg_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_item_freq</span><span class="p">)</span>
</pre></div>
<h2>Train</h2>
<p>First of all, prepare <code>reader.py</code>, the function of which is to convert raw features into encoding id. One piece of train data generates several data instances according to <code>window_size</code>, and then is fed into trainer.
</p><div class="highlight"><pre><span></span>window_size=2
train data:
user-id \t province \t city \t video-info1;video-info2;...;video-infoK \t phone

several data instances:
user-id,province,city,[&lt;unk&gt;,video-id1],[&lt;unk&gt;,category1],[&lt;unk&gt;,tags1],phone,video-id2
user-id,province,city,[video-id1,video-id2],[category1,category2],[tags1,tags2],phone,video-id3
user-id,province,city,[video-id2,video-id3],[category2,category3],[tags2,tags3],phone,video-id4
......
</pre></div>
The relevant code is as follows:
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">history_clicked_items_all</span><span class="p">)):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window_size</span><span class="p">)</span>
    <span class="n">history_clicked_items</span> <span class="o">=</span> <span class="n">history_clicked_items_all</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">history_clicked_categories</span> <span class="o">=</span> <span class="n">history_clicked_categories_all</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">history_clicked_tags_str</span> <span class="o">=</span> <span class="n">history_clicked_tags_all</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">history_clicked_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tags_a</span> <span class="ow">in</span> <span class="n">history_clicked_tags_str</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags_a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_"</span><span class="p">):</span>
            <span class="n">history_clicked_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
    <span class="n">target_item</span> <span class="o">=</span> <span class="n">history_clicked_items_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">province</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> \
          <span class="n">history_clicked_items</span><span class="p">,</span> <span class="n">history_clicked_categories</span><span class="p">,</span> \
          <span class="n">history_clicked_tags</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">target_item</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="n">feature_dict</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
        <span class="n">paddle</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span>
            <span class="n">paddle</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">reader</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">train_set_path</span><span class="p">),</span>
                <span class="n">buf_size</span><span class="o">=</span><span class="mi">7000</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">),</span>
        <span class="n">num_passes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_passes</span><span class="p">,</span>
        <span class="n">feeding</span><span class="o">=</span><span class="n">feeding</span><span class="p">,</span>
        <span class="n">event_handler</span><span class="o">=</span><span class="n">event_handler</span><span class="p">)</span>
</pre></div>
Then start training.
<div class="highlight"><pre><span></span>mkdir output/model
python train.py --train_set_path<span class="o">=</span><span class="s1">'./data/train.txt'</span> <span class="se">\</span>
    --test_set_path<span class="o">=</span><span class="s1">'./data/test.txt'</span> <span class="se">\</span>
    --model_output_dir<span class="o">=</span><span class="s1">'./output/model/'</span> <span class="se">\</span>
    --feature_dict<span class="o">=</span><span class="s1">'./output/feature_dict.pkl'</span> <span class="se">\</span>
    --item_freq<span class="o">=</span><span class="s1">'./output/item_freq.pkl'</span>
</pre></div>
<h2>Offline prediction</h2>
<p>Input user related features, and then get the most likely N videos for user.
</p><div class="highlight"><pre><span></span>python infer.py --infer_set_path<span class="o">=</span><span class="s1">'./data/infer.txt'</span> <span class="se">\</span>
    --model_path<span class="o">=</span><span class="s1">'./output/model/model_pass_00000.tar.gz'</span> <span class="se">\</span>
    --feature_dict<span class="o">=</span><span class="s1">'./output/feature_dict.pkl'</span> <span class="se">\</span>
    --batch_size<span class="o">=</span><span class="m">50</span>
</pre></div>
<h2>Online prediction</h2>
<p>For online prediction, Approximate Nearest Neighbor(ANN) is adopted to directly recall top N most likely watch video. Here shows how to get user vector and video vector.</p>
<h3>User Vector</h3>
<p>User vector is the output of the last RELU layer with cascading a constant term 1 in the front. Here the dimension of the last RELU layer is 31, and thus the dimension of user vector is 32.</p>
<p><img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D%3D%5B1%2Cu_1%2Cu_2%2C...%2Cu_%7B31%7D%5D"/></p>
<h3>Video Vector</h3>
<p>Video vector is extracted from the parameters of softmax layer. If there are M different videos, the output of softmax layer will be the probability of click of these M videos.</p>
<p><img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bo%7D%3D%5Bs_1%2Cs_2%2C...%2Cs_%7BM%7D%5D"/></p>
<p>To get <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bo%7D"/> from user vector <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D"/>, a <img alt="" src="https://www.zhihu.com/equation?tex=32%5Ctimes%20M"/> matrix which consists of the parameters w, b of softmax layer is multiplied. Each column of this matrix is a 32-dim video vector, according to the dictionary order one by one.</p>
<p><img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D%5Ccdot%20%5Cbegin%7Bbmatrix%7D%0A%20b_1%20%20%26%20b_2%20%26%20%20%5Ccdots%20%26%20b_M%20%5C%5C%20%0A%20w_%7B11%7D%20%26%20w_%7B21%7D%20%26%20%20%5Ccdots%20%20%26%20w_%7BM1%7D%20%5C%5C%20%0A%20w_%7B12%7D%20%26%20w_%7B22%7D%20%26%20%20%20%5Ccdots%20%26%20w_%7BM2%7D%20%20%5C%5C%20%0A%5Cvdots%20%26%20%5Cvdots%20%26%20%20%5Cvdots%20%26%20%5Cvdots%20%5C%5C%20%0Aw_%7B131%7D%20%26%20%20w_%7B231%7D%20%26%20%20%5Ccdots%20%20%26%20w_%7BM31%7D%20%20%0A%5Cend%7Bbmatrix%7D_%7B32%5Ctimes%20M%7D%20%3D%20%5Cmathbf%7Bu%7D%20%5Ccdot%20%20%5Cbegin%7Bbmatrix%7D%20%0A%5Cmathbf%7Bv_1%7D%2C%20%5Cmathbf%7Bv_2%7D%2C%20%5Ccdots%2C%20%5Cmathbf%7Bv_M%7D%20%0A%5Cend%7Bbmatrix%7D_%7B1%5Ctimes%20M%7D%3D%5Cmathbf%7Bo%7D"/></p>
<h3>SIMPLE-LSH conversion</h3>
<p>However, most of ANN systems currently only support cosin sorting, not by inner product sorting, which leads to big effect difference.</p>
<p>To solve it, user and video vectors are sliently modified by a SIMPLE-LSH conversion[<a href="#References">4</a>], so that inner sorting is equivalent to cosin sorting after conversion.</p>
<p>Details are as follows:
- For video vector <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bv%7D%5Cin%20%5Cmathbb%7BR%7D%5EN"/>, <img alt="" src="https://www.zhihu.com/equation?tex=%5Cleft%20%5C%7C%20%5Cmathbf%7Bv%7D%20%5Cright%20%5C%7C%5Cleqslant%20m"/>. The modified video vector <img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bv%7D%7D%5Cin%20%5Cmathbb%7BR%7D%5E%7BN%2B1%7D"/>, and let <img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bv%7D%7D%20%3D%20%5B%5Cfrac%7B%5Cmathbf%7Bv%7D%7D%7Bm%7D%3B%20%5Csqrt%7B1%20-%5Cleft%20%5C%7C%20%5Cmathbf%7B%5Cfrac%7B%5Cmathbf%7Bv%7D%7D%7Bm%7D%7B%7D%7D%20%5Cright%20%5C%7C%5E2%7D%5D"/>.</p>
<ul>
<li>For user vector <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D%5Cin%20%5Cmathbb%7BR%7D%5EN"/>, and the modified user vector <img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%5Cin%20%5Cmathbb%7BR%7D%5E%7BN%2B1%7D"/>, and let <img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%20%3D%20%5B%5Cmathbf%7Bu%7D_%7Bnorm%7D%3B%200%5D"/>, where <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D_%7Bnorm%7D"/> is normalized <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D"/>.</li>
</ul>
<p>When online predicting, for a coming <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D"/>, it should recall <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bv%7D"/> by inner product sorting. After <img alt="" src="https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D%5Crightarrow%20%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%2C%20%5Cmathbf%7Bv%7D%5Crightarrow%20%5Ctilde%7B%5Cmathbf%7Bv%7D%7D"/> conversion, the order of inner prodct sorting is unchanged. Since <img alt="" src="https://www.zhihu.com/equation?tex=%5Cleft%20%5C%7C%20%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%20%5Cright%20%5C%7C"/> and <img alt="" src="https://www.zhihu.com/equation?tex=%5Cleft%20%5C%7C%20%5Ctilde%7B%5Cmathbf%7Bv%7D%7D%20%5Cright%20%5C%7C"/> are both equal to 1, <img alt="" src="https://www.zhihu.com/equation?tex=cos(%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%20%2C%5Ctilde%7B%5Cmathbf%7Bv%7D%7D"/>%20%3D%20%5Ctilde%7B%5Cmathbf%7Bu%7D%7D%5Ccdot%20%5Ctilde%7B%5Cmathbf%7Bv%7D%7D), which makes cosin-supported-only ANN system works.</p>
<p>And in order to retain precision, use <img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bv%7D%7D%3D%5B%5Cmathbf%7Bv%7D%3B%5Csqrt%7Bm%5E2-%5Cleft%5C%7C%20%5Cmathbf%7B%5Cmathbf%7Bv%7D%7D%5Cright%5C%7C%5E2%7D%5D"/> is also equivalent.</p>
<h3>Implemention</h3>
<p>Run <code>user_vector.py</code> to generate user vector. First input the features into network and then infer. The output of the last RELU layer is saved in variable probs[1]. By cascading a contant term 1 in the front and making SIMPLE-LSH conversion, user vector is generated.
</p><div class="highlight"><pre><span></span><span class="n">probs</span> <span class="o">=</span> <span class="n">inferer</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">test_batch</span><span class="p">,</span>
        <span class="n">feeding</span><span class="o">=</span><span class="n">feeding</span><span class="p">,</span>
        <span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s2">"value"</span><span class="p">],</span>
        <span class="n">flatten_result</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">probs</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
    <span class="c1"># do simple lsh conversion</span>
    <span class="n">user_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.000</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">user_vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">user_vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.000</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">user_vector</span><span class="p">)</span>
    <span class="n">user_vector_norm</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span> <span class="o">/</span> <span class="n">norm</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">user_vector</span><span class="p">]</span>
    <span class="k">print</span> <span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_vector_norm</span><span class="p">)</span>
</pre></div>
<p>Run <code>item_vector.py</code> to generate video vector. First load the model and extract the parameters nce_w and nce_b. And then generate ith video vector by putting nce_b[0][i] in the first dimension and nce_b[0][i] in the next. Finally make SIMPLE-LSH conversion, finding the maximum norm and processing according to <img alt="" src="https://www.zhihu.com/equation?tex=%5Ctilde%7B%5Cmathbf%7Bv%7D%7D%3D%5B%5Cmathbf%7Bv%7D%3B%5Csqrt%7Bm%5E2-%5Cleft%5C%7C%20%5Cmathbf%7B%5Cmathbf%7Bv%7D%7D%5Cright%5C%7C%5E2%7D%5D"/>.</p>
<div class="highlight"><pre><span></span><span class="c1"># load the trained model.</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">Parameters</span><span class="o">.</span><span class="n">from_tar</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">nce_w</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"nce_w"</span><span class="p">)</span>
    <span class="n">nce_b</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"nce_b"</span><span class="p">)</span>
    <span class="n">item_vector</span> <span class="o">=</span> <span class="n">convt_simple_lsh</span><span class="p">(</span><span class="n">get_item_vec_from_softmax</span><span class="p">(</span><span class="n">nce_w</span><span class="p">,</span> <span class="n">nce_b</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_item_vec_from_softmax</span><span class="p">(</span><span class="n">nce_w</span><span class="p">,</span> <span class="n">nce_b</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    get item vectors from softmax parameter</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">nce_w</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">nce_b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_items_num</span> <span class="o">=</span> <span class="n">nce_w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">total_items_num</span> <span class="o">!=</span> <span class="n">nce_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">dim_vector</span> <span class="o">=</span> <span class="n">nce_w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_items_num</span><span class="p">):</span>
        <span class="n">vector</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nce_b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim_vector</span><span class="p">):</span>
            <span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nce_w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">vector</span>


<span class="k">def</span> <span class="nf">convt_simple_lsh</span><span class="p">(</span><span class="n">vector</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    do simple lsh conversion</span>
<span class="sd">    """</span>
    <span class="n">max_norm</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_of_vec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_of_vec</span><span class="p">):</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="o">&gt;</span> <span class="n">max_norm</span><span class="p">:</span>
            <span class="n">max_norm</span> <span class="o">=</span> <span class="n">norm</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_of_vec</span><span class="p">):</span>
        <span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">max_norm</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">vector</span>
</pre></div>
<p>Use <code>user_vector.py</code> and <code>item_vector.py</code> to calculate user and item vectors. For example, run the following commands:
</p><div class="highlight"><pre><span></span>python user_vector.py --infer_set_path<span class="o">=</span><span class="s1">'./data/infer.txt'</span> <span class="se">\</span>
        --model_path<span class="o">=</span><span class="s1">'./output/model/model_pass_00000.tar.gz'</span> <span class="se">\</span>
            --feature_dict<span class="o">=</span><span class="s1">'./output/feature_dict.pkl'</span> <span class="se">\</span>
                --batch_size<span class="o">=</span><span class="m">50</span>
python item_vector.py --model_path<span class="o">=</span><span class="s1">'./output/model/model_pass_00000.tar.gz'</span> <span class="se">\</span>
            --feature_dict<span class="o">=</span><span class="s1">'./output/feature_dict.pkl'</span>
</pre></div>
<h2>Offline data mining</h2>
<p>Since it is inevitable to consume large amount of machine resources for online predicting, an alternative is offline data mining, e.g. hottest videos, user personalized recommendation, item-based recommendation, and online systems directly access it. Here shows an example to get user personalized recommendation.
</p><div class="highlight"><pre><span></span>python infer_user.py --model_path='./output/model/model_pass_00000.tar.gz' \
            --feature_dict='./output/feature_dict.pkl'
</pre></div>
<h2>References</h2>
<ol>
<li>Covington, Paul, Jay Adams, and Emre Sargin. "Deep neural networks for youtube recommendations." Proceedings of the 10th ACM Conference on Recommender Systems. ACM, 2016.</li>
<li>https://code.google.com/archive/p/word2vec/</li>
<li>http://paddlepaddle.org/docs/develop/models/nce_cost/README.html</li>
<li>Neyshabur, Behnam, and Nathan Srebro. "On symmetric and asymmetric LSHs for inner product search." arXiv preprint arXiv:1410.5518 (2014).</li>
</ol>
{% endverbatim %}