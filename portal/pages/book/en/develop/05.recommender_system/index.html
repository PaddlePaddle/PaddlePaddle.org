{% verbatim %}
<h1>Personalized Recommendation</h1>
<p>The source code from this tutorial is at <a href="https://github.com/PaddlePaddle/book/tree/develop/05.recommender_system">here</a>.  For instructions to run it, please refer to <a href="https://github.com/PaddlePaddle/book/blob/develop/README.md#running-the-book">this guide</a>.</p>
<h2>Background</h2>
<p>The recommender system is a component of e-commerce, online videos, and online reading services.  There are several different approaches for recommender systems to learn from user behavior and product properties and to understand users' interests.</p>
<ul>
<li>
<p>User behavior-based approach.  A well-known method of this approach is collaborative filtering, which assumes that if two users made similar purchases, they share common interests and would likely go on making the same decision. Some variants of collaborative filtering are user-based[<a href="#references">3</a>], item-based [<a href="#references">4</a>], social network based[<a href="#references">5</a>], and model-based.</p>
</li>
<li>
<p>Content-based approach[<a href="#references">1</a>].  This approach represents product properties and user interests as feature vectors of the same space so that it could measure how much a user is interested in a product by the distance between two feature vectors.</p>
</li>
<li>
<p>Hybrid approach[<a href="#references">2</a>]: This one combines above two to help with each other about the data sparsity problem[<a href="#references">6</a>].</p>
</li>
</ul>
<p>This tutorial explains a deep learning based hybrid approach and its implement in PaddlePaddle.  We are going to train a model using a dataset that includes user information, movie information, and ratings.  Once we train the model, we will be able to get a predicted rating given a pair of user and movie IDs.</p>
<h2>Model Overview</h2>
<p>To know more about deep learning based recommendation, let us start from going over the Youtube recommender system[<a href="#references">7</a>] before introducing our hybrid model.</p>
<h3>YouTube's Deep Learning Recommendation Model</h3>
<p>YouTube is a video-sharing Web site with one of the largest user base in the world.  Its recommender system serves more than a billion users.  This system is composed of two major parts: candidate generation and ranking.  The former selects few hundreds of candidates from millions of videos, and the latter ranks and outputs the top 10.</p>
<p align="center">
<img src="image/YouTube_Overview.en.png" width="70%"/><br/>
Figure 1. YouTube recommender system overview.
</p>
<h4>Candidate Generation Network</h4>
<p>YouTube models candidate generation as a multi-class classification problem with a huge number of classes equal to the number of videos.  The architecture of the model is as follows:</p>
<p align="center">
<img src="image/Deep_candidate_generation_model_architecture.en.png" width="70%"/><br/>
Figure 2. Deep candidate generation model.
</p>
<p>The first stage of this model maps watching history and search queries into fixed-length representative features.  Then, an MLP (multi-layer Perceptron, as described in the <a href="https://github.com/PaddlePaddle/book/blob/develop/recognize_digits/README.md">Recognize Digits</a> tutorial) takes the concatenation of all representative vectors.  The output of the MLP represents the user' <em>intrinsic interests</em>.  At training time, it is used together with a softmax output layer for minimizing the classification error.   At serving time, it is used to compute the relevance of the user with all movies.</p>
<p>For a user <span class="markdown-equation" id="equation-0">$U$</span>, the predicted watching probability of video <span class="markdown-equation" id="equation-1">$i$</span> is</p>
<p><span class="markdown-equation" id="equation-2">$$P(\omega=i|u)=\frac{e^{v_{i}u}}{\sum_{j \in V}e^{v_{j}u}}$$</span></p>
<p>where <span class="markdown-equation" id="equation-3">$u$</span> is the representative vector of user <span class="markdown-equation" id="equation-0">$U$</span>, <span class="markdown-equation" id="equation-5">$V$</span> is the corpus of all videos, <span class="markdown-equation" id="equation-6">$v_i$</span> is the representative vector of the <span class="markdown-equation" id="equation-1">$i$</span>-th video. <span class="markdown-equation" id="equation-3">$u$</span> and <span class="markdown-equation" id="equation-6">$v_i$</span> are vectors of the same length, so we can compute their dot product using a fully connected layer.</p>
<p>This model could have a performance issue as the softmax output covers millions of classification labels.  To optimize performance, at the training time, the authors down-sample negative samples, so the actual number of classes is reduced to thousands.  At serving time, the authors ignore the normalization of the softmax outputs, because the results are just for ranking.</p>
<h4>Ranking Network</h4>
<p>The architecture of the ranking network is similar to that of the candidate generation network.  Similar to ranking models widely used in online advertising, it uses rich features like video ID, last watching time, etc.  The output layer of the ranking network is a weighted logistic regression, which rates all candidate videos.</p>
<h3>Hybrid Model</h3>
<p>In the section, let us introduce our movie recommendation system. Especially, we feed moives titles into a text convolution network to get a fixed-length representative feature vector. Accordingly we will introduce the convolutional neural network for texts and the hybrid recommendation model respectively.</p>
<h4>Convolutional Neural Networks for Texts (CNN)</h4>
<p><strong>Convolutional Neural Networks</strong> are frequently applied to data with grid-like topology such as two-dimensional images and one-dimensional texts. A CNN can extract multiple local features, combine them, and produce high-level abstractions, which correspond to semantic understanding. Empirically, CNN is shown to be efficient for image and text modeling.</p>
<p>CNN mainly contains convolution and pooling operation, with versatile combinations in various applications. Here, we briefly describe a CNN as shown in Figure 3.</p>
<p align="center">
<img align="center" src="image/text_cnn_en.png" width="80%"/><br/>
Figure 3. CNN for text modeling.
</p>
<p>Let <span class="markdown-equation" id="equation-10">$n$</span> be the length of the sentence to process, and the <span class="markdown-equation" id="equation-1">$i$</span>-th word has embedding as <span class="markdown-equation" id="equation-12">$x_i\in\mathbb{R}^k$</span>，where <span class="markdown-equation" id="equation-13">$k$</span> is the embedding dimensionality.</p>
<p>First, we concatenate the words by piecing together every <span class="markdown-equation" id="equation-14">$h$</span> words, each as a window of length <span class="markdown-equation" id="equation-14">$h$</span>. This window is denoted as <span class="markdown-equation" id="equation-16">$x_{i:i+h-1}$</span>, consisting of <span class="markdown-equation" id="equation-17">$x_{i},x_{i+1},\ldots,x_{i+h-1}$</span>, where <span class="markdown-equation" id="equation-18">$x_i$</span> is the first word in the window and <span class="markdown-equation" id="equation-1">$i$</span> takes value ranging from <span class="markdown-equation" id="equation-20">$1$</span> to <span class="markdown-equation" id="equation-21">$n-h+1$</span>: <span class="markdown-equation" id="equation-22">$x_{i:i+h-1}\in\mathbb{R}^{hk}$</span>.</p>
<p>Next, we apply the convolution operation: we apply the kernel <span class="markdown-equation" id="equation-23">$w\in\mathbb{R}^{hk}$</span> in each window, extracting features <span class="markdown-equation" id="equation-24">$c_i=f(w\cdot x_{i:i+h-1}+b)$</span>, where <span class="markdown-equation" id="equation-25">$b\in\mathbb{R}$</span> is the bias and <span class="markdown-equation" id="equation-26">$f$</span> is a non-linear activation function such as <span class="markdown-equation" id="equation-27">$sigmoid$</span>. Convolving by the kernel at every window <span class="markdown-equation" id="equation-28">${x_{1:h},x_{2:h+1},\ldots,x_{n-h+1:n}}$</span> produces a feature map in the following form:</p>
<p><span class="markdown-equation" id="equation-29">$$c=[c_1,c_2,\ldots,c_{n-h+1}], c \in \mathbb{R}^{n-h+1}$$</span></p>
<p>Next, we apply <em>max pooling</em> over time to represent the whole sentence <span class="markdown-equation" id="equation-30">$\hat c$</span>, which is the maximum element across the feature map:</p>
<p><span class="markdown-equation" id="equation-31">$$\hat c=max(c)$$</span></p>
<h4>Model Structure Of The Hybrid Model</h4>
<p>In our network, the input includes features of users and movies.  The user feature includes four properties: user ID, gender, occupation, and age.  Movie features include their IDs, genres, and titles.</p>
<p>We use fully-connected layers to map user features into representative feature vectors and concatenate them.  The process of movie features is similar, except that for movie titles -- we feed titles into a text convolution network as described in the above section to get a fixed-length representative feature vector.</p>
<p>Given the feature vectors of users and movies, we compute the relevance using cosine similarity.  We minimize the squared error at training time.</p>
<p align="center">
<img src="image/rec_regression_network_en.png" width="90%"/><br/>
Figure 4. A hybrid recommendation model.
</p>
<h2>Dataset</h2>
<p>We use the <a href="http://files.grouplens.org/datasets/movielens/ml-1m.zip">MovieLens ml-1m</a> to train our model.  This dataset includes 10,000 ratings of 4,000 movies from 6,000 users to 4,000 movies.  Each rate is in the range of 1~5.  Thanks to GroupLens Research for collecting, processing and publishing the dataset.</p>
<p><code>paddle.v2.datasets</code> package encapsulates multiple public datasets, including <code>cifar</code>, <code>imdb</code>, <code>mnist</code>, <code>moivelens</code> and <code>wmt14</code>, etc. There's no need for us to manually download and preprocess <code>MovieLens</code> dataset.</p>
<p>The raw <code>MoiveLens</code> contains movie ratings, relevant features from both movies and users.
For instance, one movie's feature could be:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">paddle.v2</span> <span class="kn">as</span> <span class="nn">paddle</span>
<span class="n">movie_info</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">movie_info</span><span class="p">()</span>
<span class="k">print</span> <span class="n">movie_info</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
<div class="highlight"><pre><span></span>&lt;MovieInfo id(1), title(Toy Story), categories(['Animation', "Children's", 'Comedy'])&gt;
</pre></div>
<p>One user's feature could be:</p>
<div class="highlight"><pre><span></span><span class="n">user_info</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">user_info</span><span class="p">()</span>
<span class="k">print</span> <span class="n">user_info</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
<div class="highlight"><pre><span></span>&lt;UserInfo id(1), gender(F), age(1), job(10)&gt;
</pre></div>
<p>In this dateset, the distribution of age is shown as follows:</p>
<div class="highlight"><pre><span></span>1: "Under 18"
18: "18-24"
25: "25-34"
35: "35-44"
45: "45-49"
50: "50-55"
56: "56+"
</pre></div>
<p>User's occupation is selected from the following options:</p>
<div class="highlight"><pre><span></span>0: "other" or not specified
1: "academic/educator"
2: "artist"
3: "clerical/admin"
4: "college/grad student"
5: "customer service"
6: "doctor/health care"
7: "executive/managerial"
8: "farmer"
9: "homemaker"
10: "K-12 student"
11: "lawyer"
12: "programmer"
13: "retired"
14: "sales/marketing"
15: "scientist"
16: "self-employed"
17: "technician/engineer"
18: "tradesman/craftsman"
19: "unemployed"
20: "writer"
</pre></div>
<p>Each record consists of three main components: user features, movie features and movie ratings.
Likewise, as a simple example, consider the following:</p>
<div class="highlight"><pre><span></span><span class="n">train_set_creator</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="n">train_sample</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">train_set_creator</span><span class="p">())</span>
<span class="n">uid</span> <span class="o">=</span> <span class="n">train_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mov_id</span> <span class="o">=</span> <span class="n">train_sample</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">user_info</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">())]</span>
<span class="k">print</span> <span class="s2">"User </span><span class="si">%s</span><span class="s2"> rates Movie </span><span class="si">%s</span><span class="s2"> with Score </span><span class="si">%s</span><span class="s2">"</span><span class="o">%</span><span class="p">(</span><span class="n">user_info</span><span class="p">[</span><span class="n">uid</span><span class="p">],</span> <span class="n">movie_info</span><span class="p">[</span><span class="n">mov_id</span><span class="p">],</span> <span class="n">train_sample</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
<div class="highlight"><pre><span></span>User &lt;UserInfo id(1), gender(F), age(1), job(10)&gt; rates Movie &lt;MovieInfo id(1193), title(One Flew Over the Cuckoo's Nest), categories(['Drama'])&gt; with Score [5.0]
</pre></div>
<p>The output shows that user 1 gave movie <code>1193</code> a rating of 5.</p>
<p>After issuing a command <code>python train.py</code>, training will start immediately. The details will be unpacked by the following sessions to see how it works.</p>
<h2>Model Architecture</h2>
<h3>Initialize PaddlePaddle</h3>
<p>First, we must import and initialize PaddlePaddle (enable/disable GPU, set the number of trainers, etc).</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">paddle.v2</span> <span class="kn">as</span> <span class="nn">paddle</span>
<span class="n">paddle</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
<h3>Model Configuration</h3>
<div class="highlight"><pre><span></span><span class="n">uid</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'user_id'</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span>
        <span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">max_user_id</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">usr_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">usr_fc</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">usr_emb</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>

<span class="n">usr_gender_id</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'gender_id'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="n">usr_gender_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">usr_gender_id</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">usr_gender_fc</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">usr_gender_emb</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">usr_age_id</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'age_id'</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">age_table</span><span class="p">)))</span>
<span class="n">usr_age_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">usr_age_id</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">usr_age_fc</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">usr_age_emb</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">usr_job_id</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'job_id'</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span>
        <span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">max_job_id</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">usr_job_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">usr_job_id</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">usr_job_fc</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">usr_job_emb</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
<p>As shown in the above code, the input is four dimension integers for each user, that is,  <code>user_id</code>,<code>gender_id</code>, <code>age_id</code> and <code>job_id</code>. In order to deal with these features conveniently, we use the language model in NLP to transform these discrete values into embedding vaules <code>usr_emb</code>, <code>usr_gender_emb</code>, <code>usr_age_emb</code> and <code>usr_job_emb</code>.</p>
<div class="highlight"><pre><span></span><span class="n">usr_combined_features</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="n">usr_fc</span><span class="p">,</span> <span class="n">usr_gender_fc</span><span class="p">,</span> <span class="n">usr_age_fc</span><span class="p">,</span> <span class="n">usr_job_fc</span><span class="p">],</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">act</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">activation</span><span class="o">.</span><span class="n">Tanh</span><span class="p">())</span>
</pre></div>
<p>Then, employing user features as input, directly connecting to a fully-connected layer, which is used to reduce dimension to 200.</p>
<p>Furthermore, we do a similar transformation for each movie feature. The model configuration is:</p>
<div class="highlight"><pre><span></span><span class="n">mov_id</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'movie_id'</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value</span><span class="p">(</span>
        <span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">max_movie_id</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">mov_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">mov_id</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">mov_fc</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">mov_emb</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>

<span class="n">mov_categories</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'category_id'</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">sparse_binary_vector</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">movie_categories</span><span class="p">())))</span>
<span class="n">mov_categories_hidden</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">mov_categories</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>

<span class="n">movie_title_dict</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">get_movie_title_dict</span><span class="p">()</span>
<span class="n">mov_title_id</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'movie_title'</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">integer_value_sequence</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">movie_title_dict</span><span class="p">)))</span>
<span class="n">mov_title_emb</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">mov_title_id</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">mov_title_conv</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">sequence_conv_pool</span><span class="p">(</span>
    <span class="nb">input</span><span class="o">=</span><span class="n">mov_title_emb</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">context_len</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">mov_combined_features</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span>
    <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="n">mov_fc</span><span class="p">,</span> <span class="n">mov_categories_hidden</span><span class="p">,</span> <span class="n">mov_title_conv</span><span class="p">],</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">act</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">activation</span><span class="o">.</span><span class="n">Tanh</span><span class="p">())</span>
</pre></div>
<p>Movie title, a sequence of words represented by an integer word index sequence, will be feed into a <code>sequence_conv_pool</code> layer, which will apply convolution and pooling on time dimension. Because pooling is done on time dimension, the output will be a fixed-length vector regardless the length of the input sequence.</p>
<p>Finally, we can use cosine similarity to calculate the similarity between user characteristics and movie features.</p>
<div class="highlight"><pre><span></span><span class="n">inference</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">cos_sim</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">usr_combined_features</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">mov_combined_features</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">cost</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">square_error_cost</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">inference</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">'score'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">dense_vector</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
</pre></div>
<h2>Model Training</h2>
<h3>Define Parameters</h3>
<p>First, we define the model parameters according to the previous model configuration <code>cost</code>.</p>
<div class="highlight"><pre><span></span><span class="c1"># Create parameters</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
</pre></div>
<h3>Create Trainer</h3>
<p>Before jumping into creating a training module, algorithm setting is also necessary. Here we specified Adam optimization algorithm via <code>paddle.optimizer</code>.</p>
<div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
                             <span class="n">update_equation</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">))</span>
</pre></div>
<div class="highlight"><pre><span></span>[INFO 2017-03-06 17:12:13,378 networks.py:1472] The input order is [user_id, gender_id, age_id, job_id, movie_id, category_id, movie_title, score]
[INFO 2017-03-06 17:12:13,379 networks.py:1478] The output order is [__square_error_cost_0__]
</pre></div>
<h3>Training</h3>
<p><code>paddle.dataset.movielens.train</code> will yield records during each pass, after shuffling, a batch input is generated for training.</p>
<div class="highlight"><pre><span></span><span class="n">reader</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span>
    <span class="n">paddle</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span>
        <span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">train</span><span class="p">(),</span> <span class="n">buf_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
</pre></div>
<p><code>feeding</code> is devoted to specifying the correspondence between each yield record and <code>paddle.layer.data</code>. For instance, the first column of data generated by <code>movielens.train</code> corresponds to <code>user_id</code> feature.</p>
<div class="highlight"><pre><span></span><span class="n">feeding</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'user_id'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">'gender_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">'age_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">'job_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">'movie_id'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">'category_id'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">'movie_title'</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s1">'score'</span><span class="p">:</span> <span class="mi">7</span>
<span class="p">}</span>
</pre></div>
<p>Callback function <code>event_handler</code> and  <code>event_handler_plot</code> will be called during training when a pre-defined event happens.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">event_handler</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">paddle</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">EndIteration</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">batch_id</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">"Pass </span><span class="si">%d</span><span class="s2"> Batch </span><span class="si">%d</span><span class="s2"> Cost </span><span class="si">%.2f</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">pass_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">cost</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">paddle.v2.plot</span> <span class="kn">import</span> <span class="n">Ploter</span>

<span class="n">train_title</span> <span class="o">=</span> <span class="s2">"Train cost"</span>
<span class="n">test_title</span> <span class="o">=</span> <span class="s2">"Test cost"</span>
<span class="n">cost_ploter</span> <span class="o">=</span> <span class="n">Ploter</span><span class="p">(</span><span class="n">train_title</span><span class="p">,</span> <span class="n">test_title</span><span class="p">)</span>

<span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">event_handler_plot</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">step</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">paddle</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">EndIteration</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># every 10 batches, record a train cost</span>
            <span class="n">cost_ploter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_title</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">cost</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># every 1000 batches, record a test cost</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
                <span class="n">reader</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span>
                    <span class="n">paddle</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">movielens</span><span class="o">.</span><span class="n">test</span><span class="p">(),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">),</span>
                <span class="n">feeding</span><span class="o">=</span><span class="n">feeding</span><span class="p">)</span>
            <span class="n">cost_ploter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_title</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">cost</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># every 100 batches, update cost plot</span>
            <span class="n">cost_ploter</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
<p>Finally, we can invoke <code>trainer.train</code> to start training:</p>
<div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
    <span class="n">reader</span><span class="o">=</span><span class="n">reader</span><span class="p">,</span>
    <span class="n">event_handler</span><span class="o">=</span><span class="n">event_handler_plot</span><span class="p">,</span>
    <span class="n">feeding</span><span class="o">=</span><span class="n">feeding</span><span class="p">,</span>
    <span class="n">num_passes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
<h2>Conclusion</h2>
<p>This tutorial goes over traditional approaches in recommender system and a deep learning based approach.  We also show that how to train and use the model with PaddlePaddle.  Deep learning has been well used in computer vision and NLP, we look forward to its new successes in recommender systems.</p>
<h2>References</h2>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Peter_Brusilovsky">Peter Brusilovsky</a> (2007). <em>The Adaptive Web</em>. p. 325.</li>
<li>Robin Burke , <a href="http://www.dcs.warwick.ac.uk/~acristea/courses/CS411/2010/Book%20-%20The%20Adaptive%20Web/HybridWebRecommenderSystems.pdf">Hybrid Web Recommender Systems</a>, pp. 377-408, The Adaptive Web, Peter Brusilovsky, Alfred Kobsa, Wolfgang Nejdl (Ed.), Lecture Notes in Computer Science, Springer-Verlag, Berlin, Germany, Lecture Notes in Computer Science, Vol. 4321, May 2007, 978-3-540-72078-2.</li>
<li>P. Resnick, N. Iacovou, etc. “<a href="http://ccs.mit.edu/papers/CCSWP165.html">GroupLens: An Open Architecture for Collaborative Filtering of Netnews</a>”, Proceedings of ACM Conference on Computer Supported Cooperative Work, CSCW 1994. pp.175-186.</li>
<li>Sarwar, Badrul, et al. "<a href="http://files.grouplens.org/papers/www10_sarwar.pdf">Item-based collaborative filtering recommendation algorithms.</a>" <em>Proceedings of the 10th International Conference on World Wide Web</em>. ACM, 2001.</li>
<li>Kautz, Henry, Bart Selman, and Mehul Shah. "<a href="http://www.cs.cornell.edu/selman/papers/pdf/97.cacm.refweb.pdf">Referral Web: Combining Social networks and collaborative filtering.</a>" Communications of the ACM 40.3 (1997): 63-65. APA</li>
<li>Yuan, Jianbo, et al. <a href="https://arxiv.org/pdf/1611.05480v1.pdf">"Solving Cold-Start Problem in Large-scale Recommendation Engines: A Deep Learning Approach."</a> <em>arXiv preprint arXiv:1611.05480</em> (2016).</li>
<li>Covington P, Adams J, Sargin E. <a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/45530.pdf">Deep neural networks for youtube recommendations</a>[C]//Proceedings of the 10th ACM Conference on Recommender Systems. ACM, 2016: 191-198.</li>
</ol>
<p><br/>
This tutorial is contributed by <a href="http://book.paddlepaddle.org" property="cc:attributionName" rel="cc:attributionURL" xmlns:cc="http://creativecommons.org/ns#">PaddlePaddle</a>, and licensed under a <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
{% endverbatim %}